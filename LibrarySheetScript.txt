/**
 * ============================================================================
 * LIBRARY: Sheet Automation Script (Standalone Project)
 * ============================================================================
 * 
 * ƒê√ÇY L√Ä LIBRARY D√ôNG CHUNG CHO T·∫§T C·∫¢ C√ÅC L·ªöP
 * 
 * H∆∞·ªõng d·∫´n setup:
 * 1. T·∫°o standalone Apps Script project m·ªõi
 * 2. Copy to√†n b·ªô code n√†y v√†o
 * 3. Deploy ‚Üí New deployment ‚Üí Type: Library
 * 4. Copy Script ID v√† phi√™n b·∫£n
 * 5. Trong m·ªói Sheet template/l·ªõp:
 *    - Resources ‚Üí Libraries ‚Üí Add library (paste Script ID)
 *    - Ch·ªçn phi√™n b·∫£n m·ªõi nh·∫•t
 *    - Identifier: "SheetLib"
 * 
 * Khi c·∫ßn update:
 * - S·ª≠a code trong library n√†y
 * - Deploy phi√™n b·∫£n m·ªõi
 * - T·∫§T C·∫¢ l·ªõp t·ª± ƒë·ªông d√πng code m·ªõi!
 * 
 * ============================================================================
 */

// ==================================================================
// CONFIG MANAGER - ƒê·ªåC C·∫§U H√åNH T·ª™ SHEET
// ==================================================================

const CONFIG_SHEET_NAME = "C·∫•u H√¨nh";

const CONFIG_COL = {
  NAME: 0,
  CLASS_TIME: 1,
  START_TIME: 2,
  DEADLINE: 3,
  AUTO_CLEAN: 4,
  SHEET_NAME: 5
};

class ConfigManager {
  constructor() {
    this.configs = [];
    this.configSheet = null;
    
    this.COL = CONFIG_COL;
  }

  loadAll() {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    this.configSheet = ss.getSheetByName(CONFIG_SHEET_NAME);
    
    if (!this.configSheet) {
      throw new Error('Kh√¥ng t√¨m th·∫•y sheet "C·∫•u H√¨nh". Vui l√≤ng t·∫°o sheet n√†y tr∆∞·ªõc.');
    }

    const lastRow = this.configSheet.getLastRow();
    if (lastRow < 2) {
      Logger.log("Sheet C·∫•u H√¨nh tr·ªëng, kh√¥ng c√≥ config n√†o.");
      return;
    }

    const dataRange = this.configSheet.getRange(2, 1, lastRow - 1, 6);
    const rows = dataRange.getValues();
    
    // ƒê·ªçc cleanup options t·ª´ Script Properties (chung cho t·∫•t c·∫£)
    const cleanupOpts = this.getCleanupOptions();

    this.configs = [];
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const name = String(row[this.COL.NAME] || "").trim();
      const classTimeStr = String(row[this.COL.CLASS_TIME] || "").trim();
      const startTimeStr = String(row[this.COL.START_TIME] || "").trim();
      const deadlineStr = String(row[this.COL.DEADLINE] || "").trim();
      const autoClean = row[this.COL.AUTO_CLEAN] === true;
      const sheetName = String(row[this.COL.SHEET_NAME] || "").trim();

      if (!name) continue;

      const isAttendance = (name.toLowerCase() === "ƒëi·ªÉm danh");

      const config = {
        name: name,
        isAttendance: isAttendance,
        classSchedules: this.parseMultiSchedule(classTimeStr),
        startTime: startTimeStr ? this.parseTimeString(startTimeStr) : null,
        deadline: deadlineStr ? this.parseTimeString(deadlineStr) : null,
        autoClean: autoClean,
        sheetName: sheetName,
        cleanupOptions: cleanupOpts  // D√πng chung t·ª´ Script Properties
      };

      this.configs.push(config);
      Logger.log(`Loaded config: ${name} (${sheetName})`);
    }
  }

  getCleanupOptions() {
    const props = PropertiesService.getScriptProperties();
    return {
      clearEmails: props.getProperty('CLEANUP_CLEAR_EMAILS') !== 'false',
      clearFormResponses: props.getProperty('CLEANUP_CLEAR_RESPONSES') !== 'false',
      clearComments: props.getProperty('CLEANUP_CLEAR_COMMENTS') !== 'false'
    };
  }

  parseMultiSchedule(str) {
    if (!str) return [];
    
    const parts = str.split(/[;,]/).map(s => s.trim()).filter(s => s);
    const schedules = [];

    for (const part of parts) {
      const parsed = this.parseTimeString(part);
      if (parsed) {
        schedules.push(parsed);
      }
    }

    return schedules;
  }

  parseTimeString(str) {
    if (!str) return null;
    
    // H·ªó tr·ª£ c·∫£ CN v√† T1 cho Ch·ªß Nh·∫≠t
    const regex = /^(CN|T[1-7])-(\d{1,2}):(\d{2})$/;
    const match = str.match(regex);
    
    if (!match) {
      Logger.log(`‚ö†Ô∏è Format th·ªùi gian kh√¥ng h·ª£p l·ªá: "${str}". Mong ƒë·ª£i: CN-18:00 ho·∫∑c T2-18:00`);
      return null;
    }

    // Chuy·ªÉn ƒë·ªïi CN/T1-T7 th√†nh s·ªë 0-6 (0=CN, 1=T2, ..., 6=T7)
    let dayNum;
    if (match[1] === 'CN') {
      dayNum = 0;
    } else {
      const tNum = parseInt(match[1].substring(1));
      dayNum = tNum === 1 ? 0 : tNum - 1; // T1->0, T2->1, T3->2, ..., T7->6
    }
    
    const hour = parseInt(match[2]);
    const minute = parseInt(match[3]);

    if (dayNum < 0 || dayNum > 6) {
      Logger.log(`‚ö†Ô∏è Ng√†y kh√¥ng h·ª£p l·ªá: ${match[1]}. Ph·∫£i l√† CN, T2-T7`);
      return null;
    }

    return {
      dayOfWeek: dayNum,
      hour: hour,
      minute: minute
    };
  }

  getAll() {
    if (this.configs.length === 0) {
      this.loadAll();
    }
    return this.configs;
  }

  getByName(name) {
    return this.getAll().find(c => c.name.toLowerCase() === name.toLowerCase());
  }

  getAllSheetNames() {
    return this.getAll()
      .filter(c => c.sheetName && !c.isAttendance)
      .map(c => c.sheetName);
  }

  getSheetsForCleanup(dayOfWeek) {
    const sheetsWithOptions = [];
    const configs = this.getAll();

    for (const config of configs) {
      if (!config.autoClean || !config.sheetName) continue;

      const hasClassOnThisDay = config.classSchedules.some(schedule => {
        return schedule.dayOfWeek === dayOfWeek;
      });

      if (hasClassOnThisDay) {
        sheetsWithOptions.push({
          sheetName: config.sheetName,
          cleanupOptions: config.cleanupOptions
        });
      }
    }

    return sheetsWithOptions;
  }

  getSheetsForDeadline(dayOfWeek) {
    const sheets = [];
    const configs = this.getAll();

    for (const config of configs) {
      if (!config.deadline || !config.sheetName) continue;

      if (config.deadline.dayOfWeek === dayOfWeek) {
        sheets.push({
          sheetName: config.sheetName,
          config: config
        });
      }
    }

    return sheets;
  }
}

// ==================================================================
// H√ÄM PUBLIC - ƒê∆Ø·ª¢C G·ªåI T·ª™ SHEET SCRIPT
// ==================================================================

/**
 * H√†m onEdit - X·ª≠ l√Ω khi edit tr·ª±c ti·∫øp trong sheet
 * G·ªåI T·ª™ SHEET: SheetLib.onEdit(e)
 */
function onEdit(e) {
  const range = e.range;
  const value = e.value;
  const row = range.getRow();
  const column = range.getColumn();
  const sheet = range.getSheet();

  // ----- 1.1: X·ª¨ L√ù ƒêI·ªÇM S·ªê ·ªû C·ªòT C (C·ªôt 3) -----
  if (column == 3 && row >= 2) {
    if (value === undefined || value === null || value === "") return;
    if (typeof value === 'string' && value.toLowerCase().trim() === 'ch∆∞a ƒë·∫°t') {
      range.setValue("Ch∆∞a ƒë·∫°t");
      return;
    }
    let numericValue;
    if (typeof value === 'string') {
      numericValue = parseFloat(value.replace(',', '.'));
    } else {
      numericValue = value;
    }
    if (!isNaN(numericValue) && numericValue < 5) {
      range.setValue("Ch∆∞a ƒë·∫°t");
    }
    return;
  }

  // ----- 1.2: T√î M√ÄU H√ÄNG D·ª∞A V√ÄO C·ªòT F (C·ªôt 6 - Ghi ch√∫) -----
  if (column === 6 && row >= 2) {
    const note = range.getValue();
    const coloringRange = sheet.getRange(row, 1, 1, sheet.getLastColumn());

    if (typeof note === 'string' && note.trim() !== '') {
      const lowerNote = note.toLowerCase();
      const hasNotSubmitted = lowerNote.includes('kh√¥ng n·ªôp') || lowerNote.includes('ch∆∞a n·ªôp');
      const hasLate = lowerNote.includes('n·ªôp mu·ªôn');
      const hasPermission = lowerNote.includes('xin ph√©p') || lowerNote.includes('c√≥ ph√©p');
      const hasWrong = lowerNote.includes('n·ªôp nh·∫ßm');

      if (hasNotSubmitted && hasPermission) {
        coloringRange.setBackground('#f9cb9c');
      }
      else if (hasNotSubmitted) {
        coloringRange.setBackground('#f6b26b');
      }
      else if (hasLate && hasPermission) {
        coloringRange.setBackground('#fff2cc');
      }
      else if (hasLate || hasWrong) {
        coloringRange.setBackground('#cccccc');
      }
      else {
        coloringRange.setBackground(null);
      }
    } else {
      coloringRange.setBackground(null);
    }
  }

  // ----- 1.3: S·ª¨A T·ª™ NG·ªÆ (K√©m, Y·∫øu, ·∫®u) -----
  if (typeof value === 'string') {
    if (value.includes("k√©m") || value.includes("y·∫øu")) {
      var newValue = value.replace(/k√©m/g, "ch∆∞a t·ªët").replace(/y·∫øu/g, "ch∆∞a t·ªët");
      range.setValue(newValue);
    }
    if (value.includes("K√©m") || value.includes("Y·∫øu")) {
      var newValue = value.replace(/K√©m/g, "Ch∆∞a t·ªët").replace(/Y·∫øu/g, "Ch∆∞a t·ªët");
      range.setValue(newValue);
    }
    if (value.includes("K√âM") || value.includes("Y·∫æU")) {
      var newValue = value.replace(/K√âM/g, "CH∆ØA T·ªêT").replace(/Y·∫æU/g, "CH∆ØA T·ªêT");
      range.setValue(newValue);
    }
    if (value.includes("·∫©u")) {
      var newValue = value.replace(/·∫©u/g, "ch∆∞a c·∫©n th·∫≠n");
      range.setValue(newValue);
    }
    if (value.includes("·∫®u")) {
      var newValue = value.replace(/·∫®u/g, "Ch∆∞a c·∫©n th·∫≠n");
      range.setValue(newValue);
    }
  }

  // ----- 1.4: ƒê·ªäNH D·∫†NG T·ª∞ ƒê·ªòNG G·∫†CH ƒê·∫¶U D√íNG C·ªòT D, E (C·ªôt 4, 5) -----
  if ((column === 4 || column === 5) && row >= 2) {
    const originalValue = range.getValue();

    if (typeof originalValue === 'string' && originalValue.trim() !== '') {
      const sentences = originalValue.replace(/\n/g, '.').split('.').filter(s => s.trim().length > 0);

      const formattedSentences = sentences.map(sentence => {
        let cleanSentence = sentence.trim();
        if (cleanSentence.startsWith('-')) {
          cleanSentence = cleanSentence.substring(1).trim();
        }
        return '- ' + cleanSentence.charAt(0).toUpperCase() + cleanSentence.slice(1);
      });

      const newValue = formattedSentences.join('.\n') + '.';

      if (newValue !== originalValue) {
        range.setValue(newValue);
      }
    }
  }

  // ----- 1.5: T·ª∞ ƒê·ªòNG VI·∫æT HOA CH·ªÆ C√ÅI ƒê·∫¶U C√ÇU (C√°c c·ªôt kh√°c) -----
  if (column !== 3 && column !== 4 && column !== 5) {
    let currentValue = range.getValue();
    if (typeof currentValue === 'string' && currentValue.length > 0) {
      const trimmedValue = currentValue.trim();
      const capitalizedValue = trimmedValue.charAt(0).toUpperCase() + trimmedValue.slice(1);
      if (capitalizedValue !== currentValue) {
        range.setValue(capitalizedValue);
      }
    }
  }
}

/**
 * T·∫°o menu t√πy ch·ªânh
 * G·ªåI T·ª™ SHEET: SheetLib.onOpen()
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  
  ui.createMenu('Ti·ªán √≠ch L·ªõp H·ªçc')
    .addItem('‚öôÔ∏è C√†i ƒë·∫∑t To√†n b·ªô L·ªãch tr√¨nh', 'SheetLib.setupSystemTriggers')
    .addSeparator()
    .addItem('üìù Ch·∫°y th·ªß c√¥ng: ƒêi·ªÅn "Ch∆∞a n·ªôp"', 'SheetLib.manualFillNotAchieved')
    .addItem('üßπ Ch·∫°y th·ªß c√¥ng: D·ªçn d·∫πp (T√πy ch·ªçn)', 'SheetLib.showCleanupDialog')
    .addSeparator()
    .addItem('üìä Xem c·∫•u h√¨nh hi·ªán t·∫°i', 'SheetLib.showCurrentConfig')
    .addItem('‚ÑπÔ∏è H∆∞·ªõng d·∫´n Setup l·∫ßn ƒë·∫ßu', 'SheetLib.showFirstTimeSetupGuide')
    .addToUi();
  
  const triggers = ScriptApp.getProjectTriggers();
  if (triggers.length === 0) {
    SpreadsheetApp.getActiveSpreadsheet().toast(
      'üí° Nh·∫•n menu "Ti·ªán √≠ch L·ªõp H·ªçc" ‚Üí "C√†i ƒë·∫∑t To√†n b·ªô L·ªãch tr√¨nh" ƒë·ªÉ k√≠ch ho·∫°t t·ª± ƒë·ªông h√≥a!',
      '‚ú® L·ªõp m·ªõi ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!',
      10
    );
  }
}

/**
 * Hi·ªÉn th·ªã c·∫•u h√¨nh hi·ªán t·∫°i
 * G·ªåI T·ª™ MENU: SheetLib.showCurrentConfig()
 */
function showCurrentConfig() {
  const ui = SpreadsheetApp.getUi();
  const configMgr = new ConfigManager();
  
  try {
    configMgr.loadAll();
    const configs = configMgr.getAll();
    
    if (configs.length === 0) {
      ui.alert('Kh√¥ng c√≥ c·∫•u h√¨nh n√†o trong sheet "C·∫•u H√¨nh".');
      return;
    }

    let message = 'üìã C·∫§U H√åNH HI·ªÜN T·∫†I:\n\n';
    
    for (const config of configs) {
      message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
      message += `üìå ${config.name}\n`;
      message += `   Sheet: ${config.sheetName || "(kh√¥ng c√≥)"}\n`;
      
      if (config.classSchedules.length > 0) {
        const scheduleStr = config.classSchedules
          .map(s => {
            const day = s.dayOfWeek === 0 ? 'CN' : `T${s.dayOfWeek + 1}`;
            return `${day}-${String(s.hour).padStart(2,'0')}:${String(s.minute).padStart(2,'0')}`;
          })
          .join(', ');
        message += `   L·ªãch h·ªçc: ${scheduleStr}\n`;
      }
      
      if (config.deadline) {
        const d = config.deadline;
        const day = d.dayOfWeek === 0 ? 'CN' : `T${d.dayOfWeek + 1}`;
        message += `   Deadline: ${day}-${String(d.hour).padStart(2,'0')}:${String(d.minute).padStart(2,'0')}\n`;
      }
      
      message += `   T·ª± ƒë·ªông d·ªçn: ${config.autoClean ? '‚úì' : '‚úó'}\n`;
    }

    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `\nT·ªïng c·ªông: ${configs.length} c·∫•u h√¨nh`;
    
    ui.alert(message);
  } catch (e) {
    ui.alert('L·ªói', 'Kh√¥ng th·ªÉ ƒë·ªçc c·∫•u h√¨nh: ' + e.message, ui.ButtonSet.OK);
  }
}

/**
 * Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n setup l·∫ßn ƒë·∫ßu
 * G·ªåI T·ª™ MENU: SheetLib.showFirstTimeSetupGuide()
 */
function showFirstTimeSetupGuide() {
  const ui = SpreadsheetApp.getUi();
  
  const guide = `
üìö H∆Ø·ªöNG D·∫™N SETUP L·∫¶N ƒê·∫¶U

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚úÖ B∆Ø·ªöC 1: Th√™m lo·∫°i b√†i t·∫≠p
   ‚Üí V√†o sheet "C·∫•u H√¨nh"
   ‚Üí Th√™m d√≤ng m·ªõi v·ªõi th√¥ng tin:
      ‚Ä¢ C·ªôt A: T√™n b√†i t·∫≠p (VD: "ƒê·∫°i s·ªë")
      ‚Ä¢ C·ªôt B: L·ªãch h·ªçc (VD: "CN-18:00;T6-09:00")
      ‚Ä¢ C·ªôt C: Th·ªùi gian m·ªü (VD: "T2-06:00")
      ‚Ä¢ C·ªôt D: Deadline (VD: "T3-23:00")
      ‚Ä¢ C·ªôt E: T√≠ch checkbox n·∫øu mu·ªën t·ª± ƒë·ªông d·ªçn
      ‚Ä¢ C·ªôt F: T√™n sheet t∆∞∆°ng ·ª©ng

‚úÖ B∆Ø·ªöC 2: K√≠ch ho·∫°t t·ª± ƒë·ªông h√≥a
   ‚Üí Menu "Ti·ªán √≠ch L·ªõp H·ªçc" 
   ‚Üí Ch·ªçn "‚öôÔ∏è C√†i ƒë·∫∑t To√†n b·ªô L·ªãch tr√¨nh"
   ‚Üí C·∫•p quy·ªÅn khi ƒë∆∞·ª£c y√™u c·∫ßu

‚úÖ B∆Ø·ªöC 3: Li√™n k·∫øt v·ªõi Form
   ‚Üí M·ªü Form c·ªßa l·ªõp
   ‚Üí Tools ‚Üí Script editor
   ‚Üí Ch·∫°y h√†m onFormSubmit test
   ‚Üí C·∫•p quy·ªÅn khi ƒë∆∞·ª£c y√™u c·∫ßu

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üí° M·∫∏O:
‚Ä¢ Xem c·∫•u h√¨nh: Menu ‚Üí "üìä Xem c·∫•u h√¨nh hi·ªán t·∫°i"
‚Ä¢ Format th·ªùi gian: CN=Ch·ªß Nh·∫≠t, T2=Th·ª© 2, ..., T7=Th·ª© 7
‚Ä¢ Multi-schedule: D√πng d·∫•u ; ho·∫∑c ,

‚ùì C√≥ th·∫Øc m·∫Øc? Ki·ªÉm tra comments trong code!
  `;
  
  ui.alert('H∆∞·ªõng d·∫´n Setup', guide, ui.ButtonSet.OK);
}

/**
 * C√†i ƒë·∫∑t triggers t·ª± ƒë·ªông
 * G·ªåI T·ª™ MENU: SheetLib.setupSystemTriggers()
 */
function setupSystemTriggers() {
  const ui = SpreadsheetApp.getUi();
  const configMgr = new ConfigManager();
  
  try {
    configMgr.loadAll();
    const configs = configMgr.getAll();
    
    if (configs.length === 0) {
      ui.alert('Sheet "C·∫•u H√¨nh" tr·ªëng ho·∫∑c kh√¥ng t·ªìn t·∫°i. Vui l√≤ng t·∫°o c·∫•u h√¨nh tr∆∞·ªõc.');
      return;
    }

    const triggers = ScriptApp.getProjectTriggers();
    for (let i = 0; i < triggers.length; i++) {
      ScriptApp.deleteTrigger(triggers[i]);
    }

    let createdCount = 0;
    let message = '‚úÖ ƒê√É C√ÄI ƒê·∫∂T TRIGGERS:\n\n';

    const cleanupSchedules = new Map();
    
    for (const config of configs) {
      if (!config.autoClean || config.classSchedules.length === 0) continue;
      
      for (const schedule of config.classSchedules) {
        const day = schedule.dayOfWeek;
        const cleanupHour = schedule.hour > 0 ? schedule.hour - 1 : 23;
        
        if (!cleanupSchedules.has(day)) {
          cleanupSchedules.set(day, new Set());
        }
        cleanupSchedules.get(day).add(cleanupHour);
      }
    }

    for (const [dayOfWeek, hours] of cleanupSchedules) {
      for (const hour of hours) {
        const weekday = convertDayOfWeekToScriptAppWeekDay(dayOfWeek);
        
        ScriptApp.newTrigger('SheetLib.runScheduledCleanup')
          .timeBased()
          .onWeekDay(weekday)
          .atHour(hour)
          .nearMinute(45)
          .create();
        
        const dayLabel = dayOfWeek === 0 ? 'CN' : `T${dayOfWeek + 1}`;
        message += `üßπ Cleanup: ${dayLabel} ${hour}:45\n`;
        createdCount++;
      }
    }

    const deadlineSchedules = new Map();
    
    for (const config of configs) {
      if (!config.deadline) continue;
      
      const day = config.deadline.dayOfWeek;
      const deadlineHour = config.deadline.hour;
      const adjustedMinute = config.deadline.minute + 30;
      const finalHour = adjustedMinute >= 60 ? (deadlineHour + 1) % 24 : deadlineHour;
      
      if (!deadlineSchedules.has(day)) {
        deadlineSchedules.set(day, new Set());
      }
      deadlineSchedules.get(day).add(finalHour);
    }

    for (const [dayOfWeek, hours] of deadlineSchedules) {
      for (const hour of hours) {
        const weekday = convertDayOfWeekToScriptAppWeekDay(dayOfWeek);
        
        ScriptApp.newTrigger('SheetLib.runScheduledDeadline')
          .timeBased()
          .onWeekDay(weekday)
          .atHour(hour)
          .nearMinute(0)
          .create();
        
        const dayLabel = dayOfWeek === 0 ? 'CN' : `T${dayOfWeek + 1}`;
        message += `üìù Deadline: ${dayLabel} ${hour}:00\n`;
        createdCount++;
      }
    }

    message += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `T·ªïng c·ªông: ${createdCount} triggers\n`;
    message += `(D·ª±a tr√™n ${configs.length} c·∫•u h√¨nh)`;
    
    ui.alert('Th√†nh c√¥ng!', message, ui.ButtonSet.OK);
    
  } catch (e) {
    ui.alert('L·ªói', 'Kh√¥ng th·ªÉ c√†i ƒë·∫∑t triggers: ' + e.message, ui.ButtonSet.OK);
    Logger.log('Error in setupSystemTriggers: ' + e.toString());
  }
}

/**
 * Ch·∫°y cleanup theo l·ªãch
 * G·ªåI T·ª™ TRIGGER: SheetLib.runScheduledCleanup()
 */
function runScheduledCleanup() {
  const now = new Date();
  const currentDay = now.getDay() === 0 ? 1 : now.getDay() + 1;
  
  const configMgr = new ConfigManager();
  configMgr.loadAll();
  
  const sheetsWithOptions = configMgr.getSheetsForCleanup(currentDay);
  
  if (sheetsWithOptions.length > 0) {
    // D·ªçn t·ª´ng sheet v·ªõi options ri√™ng
    sheetsWithOptions.forEach(item => {
      cleanSheets([item.sheetName], item.cleanupOptions);
      Logger.log(`  - ${item.sheetName}: Email=${item.cleanupOptions.clearEmails}, Responses=${item.cleanupOptions.clearFormResponses}, Comments=${item.cleanupOptions.clearComments}`);
    });
    Logger.log(`Cleaned ${sheetsWithOptions.length} sheets on day ${currentDay}`);
  }
}

/**
 * ƒêi·ªÅn "Ch∆∞a n·ªôp" sau deadline
 * G·ªåI T·ª™ TRIGGER: SheetLib.runScheduledDeadline()
 */
function runScheduledDeadline() {
  const now = new Date();
  const currentDay = now.getDay() === 0 ? 1 : now.getDay() + 1;
  
  const configMgr = new ConfigManager();
  configMgr.loadAll();
  
  const sheetsForDeadline = configMgr.getSheetsForDeadline(currentDay);
  
  if (sheetsForDeadline.length > 0) {
    const sheetNames = sheetsForDeadline.map(s => s.sheetName);
    fillMissingMarks(sheetNames);
    Logger.log(`Filled "Ch∆∞a n·ªôp" for ${sheetNames.length} sheets on day ${currentDay}`);
  }
}

/**
 * Hi·ªÉn th·ªã dialog c·∫•u h√¨nh t√πy ch·ªçn t·ª± ƒë·ªông d·ªçn d·∫πp
 * G·ªåI T·ª™ MENU: SheetLib.showCleanupDialog()
 */
function showCleanupDialog() {
  // ƒê·ªçc config hi·ªán t·∫°i
  const props = PropertiesService.getScriptProperties();
  const clearEmails = props.getProperty('CLEANUP_CLEAR_EMAILS') !== 'false';
  const clearResponses = props.getProperty('CLEANUP_CLEAR_RESPONSES') !== 'false';
  const clearComments = props.getProperty('CLEANUP_CLEAR_COMMENTS') !== 'false';
  
  const html = HtmlService.createHtmlOutput(`
    <!DOCTYPE html>
    <html>
      <head>
        <base target="_top">
        <style>
          body {
            font-family: Arial, sans-serif;
            padding: 20px;
            font-size: 14px;
          }
          h2 {
            margin-top: 0;
            color: #333;
          }
          .option {
            margin: 15px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
          }
          .option label {
            display: flex;
            align-items: center;
            cursor: pointer;
          }
          .option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
          }
          .button-container {
            margin-top: 25px;
            display: flex;
            gap: 10px;
          }
          button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
          }
          .btn-clean {
            background: #4CAF50;
            color: white;
          }
          .btn-clean:hover {
            background: #45a049;
          }
          .btn-cancel {
            background: #f44336;
            color: white;
          }
          .btn-cancel:hover {
            background: #da190b;
          }
          .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            color: #856404;
          }
        </style>
      </head>
      <body>
        <h2>‚öôÔ∏è C·∫•u h√¨nh T·ª± ƒë·ªông D·ªçn d·∫πp</h2>
        <p style="color: #666; margin-bottom: 15px;">Ch·ªçn c√°c m·ª•c s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông x√≥a tr∆∞·ªõc gi·ªù h·ªçc:</p>
        
        <div class="option">
          <label>
            <input type="checkbox" id="clearEmails" ${clearEmails ? 'checked' : ''}>
            <span><strong>1Ô∏è‚É£ X√≥a Email th√¥ng b√°o</strong> (C·ªôt B - G·ª≠i mail b√°o l·ªói)</span>
          </label>
        </div>
        
        <div class="option">
          <label>
            <input type="checkbox" id="clearFormResponses" ${clearResponses ? 'checked' : ''}>
            <span><strong>2Ô∏è‚É£ X√≥a c√¢u tr·∫£ l·ªùi Form</strong> (C·ªôt C - ƒêi·ªÉm s·ªë)</span>
          </label>
        </div>
        
        <div class="option">
          <label>
            <input type="checkbox" id="clearComments" ${clearComments ? 'checked' : ''}>
            <span><strong>3Ô∏è‚É£ X√≥a Nh·∫≠n x√©t</strong> (C·ªôt D, E, G - ∆Øu ƒëi·ªÉm, Nh∆∞·ª£c ƒëi·ªÉm & Checkbox)</span>
          </label>
        </div>
        
        <div class="warning">
          ‚ÑπÔ∏è <strong>L∆∞u √Ω:</strong> C·∫•u h√¨nh n√†y s·∫Ω √°p d·ª•ng cho T·∫§T C·∫¢ b√†i t·∫≠p khi t·ª± ƒë·ªông d·ªçn d·∫πp.
        </div>
        
        <div class="button-container">
          <button class="btn-clean" onclick="saveConfig()">üíæ L∆∞u c·∫•u h√¨nh</button>
          <button class="btn-cancel" onclick="google.script.host.close()">‚ùå H·ªßy</button>
        </div>
        
        <script>
          function saveConfig() {
            const options = {
              clearEmails: document.getElementById('clearEmails').checked,
              clearFormResponses: document.getElementById('clearFormResponses').checked,
              clearComments: document.getElementById('clearComments').checked
            };
            
            google.script.run
              .withSuccessHandler(function() {
                alert('‚úÖ ƒê√£ l∆∞u c·∫•u h√¨nh t·ª± ƒë·ªông d·ªçn d·∫πp!');
                google.script.host.close();
              })
              .withFailureHandler(function(error) {
                alert('‚ùå L·ªói: ' + error);
              })
              .SheetLib.saveCleanupConfig(options);
          }
        </script>
      </body>
    </html>
  `)
  .setWidth(450)
  .setHeight(400);
  
  SpreadsheetApp.getUi().showModalDialog(html, 'C·∫•u h√¨nh T·ª± ƒë·ªông D·ªçn d·∫πp');
}

/**
 * L∆∞u c·∫•u h√¨nh cleanup v√†o Script Properties (chung cho t·∫•t c·∫£ b√†i t·∫≠p)
 * G·ªåI T·ª™ DIALOG: SheetLib.saveCleanupConfig(options)
 */
function saveCleanupConfig(options) {
  const props = PropertiesService.getScriptProperties();
  
  props.setProperty('CLEANUP_CLEAR_EMAILS', String(options.clearEmails));
  props.setProperty('CLEANUP_CLEAR_RESPONSES', String(options.clearFormResponses));
  props.setProperty('CLEANUP_CLEAR_COMMENTS', String(options.clearComments));
  
  Logger.log(`ƒê√£ l∆∞u c·∫•u h√¨nh cleanup v√†o Script Properties: ${JSON.stringify(options)}`);
}

/**
 * Ch·∫°y th·ªß c√¥ng ƒëi·ªÅn "Ch∆∞a n·ªôp"
 * G·ªåI T·ª™ MENU: SheetLib.manualFillNotAchieved()
 */
function manualFillNotAchieved() {
  const ui = SpreadsheetApp.getUi();
  const configMgr = new ConfigManager();
  
  try {
    configMgr.loadAll();
    const allSheets = configMgr.getAll()
      .filter(c => c.sheetName)
      .map(c => c.sheetName);
    
    if (allSheets.length === 0) {
      ui.alert('Kh√¥ng c√≥ sheet n√†o trong c·∫•u h√¨nh.');
      return;
    }

    const response = ui.alert(
      'ƒêi·ªÅn "Ch∆∞a n·ªôp"?', 
      `H·ªá th·ªëng s·∫Ω ƒëi·ªÅn "Ch∆∞a n·ªôp" v√†o ${allSheets.length} sheets:\n${allSheets.join(', ')}\n\nTi·∫øp t·ª•c?`,
      ui.ButtonSet.YES_NO
    );
    
    if (response == ui.Button.YES) {
      fillMissingMarks(allSheets);
      ui.alert('‚úÖ Ho√†n t·∫•t!');
    }
  } catch (e) {
    ui.alert('L·ªói', e.message, ui.ButtonSet.OK);
  }
}

// ==================================================================
// H√ÄM INTERNAL - KH√îNG G·ªåI TR·ª∞C TI·∫æP T·ª™ B√äN NGO√ÄI
// ==================================================================

function fillMissingMarks(sheetNames) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  sheetNames.forEach(name => {
    const sheet = ss.getSheetByName(name);
    if (sheet && sheet.getLastRow() >= 2) {
      try {
        const range = sheet.getRange(2, 6, sheet.getLastRow() - 1, 2); 
        const values = range.getValues();
        let isChanged = false;

        for (let i = 0; i < values.length; i++) {
          const noteValue = values[i][0];
          const isChecked = values[i][1];

          if (isChecked !== true && (noteValue === "" || noteValue === null)) {
            values[i][0] = "Ch∆∞a n·ªôp";
            isChanged = true;
          }
        }

        if (isChanged) {
          range.setValues(values);
          Logger.log(`ƒê√£ x·ª≠ l√Ω ƒëi·ªÅn "Ch∆∞a n·ªôp" cho sheet: ${name}`);
        }
      } catch (e) {
        Logger.log(`L·ªói ƒëi·ªÅn "Ch∆∞a n·ªôp" sheet ${name}: ${e.toString()}`);
      }
    }
  });
}

function cleanSheets(sheetNames, options = {}) {
  const defaultOptions = {
    clearEmails: true,
    clearFormResponses: true,
    clearComments: true
  };
  
  const opts = Object.assign({}, defaultOptions, options);
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  sheetNames.forEach(name => {
    const sheet = ss.getSheetByName(name);
    if (sheet) {
      try {
        // 1Ô∏è‚É£ X√≥a Email th√¥ng b√°o (C·ªôt B)
        if (opts.clearEmails) {
          sheet.getRange("B2:B").clearContent();
        }
        
        // 2Ô∏è‚É£ X√≥a c√¢u tr·∫£ l·ªùi Form / ƒêi·ªÉm s·ªë (C·ªôt C)
        if (opts.clearFormResponses) {
          sheet.getRange("C2:C").clearContent();
        }
        
        // 3Ô∏è‚É£ X√≥a Nh·∫≠n x√©t (C·ªôt D, E, G - bao g·ªìm checkbox)
        if (opts.clearComments) {
          sheet.getRange("D2:E").clearContent();  // ∆Øu ƒëi·ªÉm, Nh∆∞·ª£c ƒëi·ªÉm
          sheet.getRange("G2:G").clearContent();  // Checkbox ƒë√£ n·ªôp
        }
        
        Logger.log(`ƒê√£ d·ªçn d·∫πp sheet: ${name}`);
      } catch (e) {
        Logger.log(`L·ªói d·ªçn d·∫πp sheet ${name}: ${e.toString()}`);
      }
    }
  });
}

function convertDayOfWeekToScriptAppWeekDay(dayOfWeek) {
  const mapping = {
    0: ScriptApp.WeekDay.SUNDAY,
    1: ScriptApp.WeekDay.MONDAY,
    2: ScriptApp.WeekDay.TUESDAY,
    3: ScriptApp.WeekDay.WEDNESDAY,
    4: ScriptApp.WeekDay.THURSDAY,
    5: ScriptApp.WeekDay.FRIDAY,
    6: ScriptApp.WeekDay.SATURDAY
  };
  return mapping[dayOfWeek] || ScriptApp.WeekDay.SUNDAY;
}
