/**
 * ============================================================================
 * LIBRARY: Sheet Automation Script (Standalone Project)
 * ============================================================================
 * 
 * ÄÃ‚Y LÃ€ LIBRARY DÃ™NG CHUNG CHO Táº¤T Cáº¢ CÃC Lá»šP
 * 
 * HÆ°á»›ng dáº«n setup:
 * 1. Táº¡o standalone Apps Script project má»›i
 * 2. Copy toÃ n bá»™ code nÃ y vÃ o
 * 3. Báº­t Service "Drive API" (Add a service â†’ Drive API â†’ Add)
 * 4. Deploy â†’ New deployment â†’ Type: Library
 * 5. Copy Script ID vÃ  phiÃªn báº£n
 * 6. Trong má»—i Sheet template/lá»›p:
 *    - Extensions â†’ Apps Script â†’ Resources â†’ Libraries
 *    - Add library (paste Script ID)
 *    - Chá»n phiÃªn báº£n má»›i nháº¥t
 *    - Identifier: "SheetLib"
 * 
 * Khi cáº§n update:
 * - Sá»­a code trong library nÃ y
 * - Deploy phiÃªn báº£n má»›i
 * - Táº¤T Cáº¢ lá»›p tá»± Ä‘á»™ng dÃ¹ng code má»›i!
 * 
 * ============================================================================
 */

// ==================================================================
// TIá»†N ÃCH: Tá»° Äá»˜NG Äá»”I TÃŠN APPS SCRIPT PROJECT
// ==================================================================

/**
 * HÃ m tá»± Ä‘á»™ng Ä‘á»•i tÃªn Apps Script Project cá»§a Sheet nÃ y
 * Gá»ŒI THá»¦CÃ”NG 1 Láº¦N sau khi táº¡o lá»›p má»›i Ä‘á»ƒ Ä‘áº·t tÃªn project
 * 
 * CÃ¡ch dÃ¹ng:
 * 1. Má»Ÿ Apps Script editor cá»§a Sheet (Extensions â†’ Apps Script)
 * 2. Run â†’ autoRenameScriptProject
 * 3. Authorize láº§n Ä‘áº§u
 * 4. F5 reload page Ä‘á»ƒ tháº¥y tÃªn má»›i
 */
function autoRenameScriptProject() {
  try {
    // Láº¥y tÃªn sheet hiá»‡n táº¡i
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetTitle = ss.getName();
    
    // Táº¡o tÃªn project: [SheetScript] TÃŠN_Lá»šP
    const scriptId = ScriptApp.getScriptId();
    const projectName = `[SheetScript] ${sheetTitle}`;
    
    // Gá»i Drive API Ä‘á»ƒ Ä‘á»•i tÃªn (Cáº§n báº­t Service "Drive API" trÆ°á»›c)
    Drive.Files.update({ name: projectName }, scriptId);
    
    Logger.log(`âœ… ÄÃ£ Ä‘á»•i tÃªn Project thÃ nh: "${projectName}"`);
    Logger.log("LÆ°u Ã½: Reload page (F5) Ä‘á»ƒ tháº¥y tÃªn má»›i trÃªn giao diá»‡n.");
    
    SpreadsheetApp.getUi().alert(
      `âœ… ThÃ nh cÃ´ng!\n\nÄÃ£ Ä‘á»•i tÃªn Project thÃ nh: "${projectName}"\n\nReload page (F5) Ä‘á»ƒ tháº¥y thay Ä‘á»•i.`
    );
  } catch (e) {
    Logger.log("âŒ Lá»—i: " + e.message);
    Logger.log("ğŸ‘‰ HÃ£y cháº¯c cháº¯n Ä‘Ã£ báº­t 'Drive API' trong Services.");
    
    SpreadsheetApp.getUi().alert(
      "âŒ Lá»—i\n\nKhÃ´ng thá»ƒ Ä‘á»•i tÃªn Project.\n\nÄáº£m báº£o Ä‘Ã£ báº­t 'Drive API' trong Services."
    );
  }
}

/**
 * HÃ m setup nhanh - Gá»i tá»± Ä‘á»™ng láº§n Ä‘áº§u Ä‘á»ƒ cáº¥p quyá»n vÃ  Ä‘á»•i tÃªn project
 * Gá»ŒI THá»¦CÃ”NG 1 Láº¦N hoáº·c Ä‘Æ°á»£c gá»i tá»« quickSetup tá»•ng há»£p
 * 
 * CÃ¡ch dÃ¹ng:
 * 1. Run â†’ quickSetupSheet
 * 2. Authorize táº¥t cáº£ quyá»n cáº§n thiáº¿t
 * 3. Xong!
 */
function quickSetupSheet() {
  try {
    Logger.log("ğŸš€ Äang cháº¡y Quick Setup cho Sheet...");
    
    // 1. Äá»•i tÃªn project
    Logger.log("1. Äá»•i tÃªn Apps Script Project...");
    autoRenameScriptProject();
    
    // 2. Load configs
    Logger.log("2. Táº£i cáº¥u hÃ¬nh...");
    const configMgr = new ConfigManager();
    configMgr.loadAll();
    const configs = configMgr.getAll();
    Logger.log(`âœ… Táº£i Ä‘Æ°á»£c ${configs.length} cáº¥u hÃ¬nh`);
    
    // 3. Kiá»ƒm tra xem cÃ³ FormLib khÃ´ng
    const hasFormLib = typeof FormLib !== 'undefined';
    Logger.log(`3. Kiá»ƒm tra FormLib: ${hasFormLib ? 'âœ… CÃ³' : 'âš ï¸ ChÆ°a cÃ³'}`);
    
    // 4. CÃ i Ä‘áº·t triggers tá»± Ä‘á»™ng
    Logger.log("4. CÃ i Ä‘áº·t triggers tá»± Ä‘á»™ng...");
    setupSystemTriggersQuick();
    
    Logger.log("âœ… Quick Setup hoÃ n táº¥t!");
    
    const message = hasFormLib 
      ? `âœ… Quick Setup hoÃ n táº¥t!\n\n` +
        `ğŸ“‹ ÄÃ£ cÃ i Ä‘áº·t:\n` +
        `â€¢ Cleanup tá»± Ä‘á»™ng theo lá»‹ch\n` +
        `â€¢ Äiá»n "ChÆ°a ná»™p" sau deadline\n` +
        `â€¢ Äá»‘i soÃ¡t checkbox (má»—i 1 giá»)\n\n` +
        `ğŸ’¡ Xem láº¡i triggers: Menu â†’ Tiá»‡n Ã­ch Lá»›p Há»c â†’ Xem cáº¥u hÃ¬nh hiá»‡n táº¡i`
      : `âœ… Quick Setup hoÃ n táº¥t!\n\n` +
        `ğŸ“‹ ÄÃ£ cÃ i Ä‘áº·t:\n` +
        `â€¢ Cleanup tá»± Ä‘á»™ng theo lá»‹ch\n` +
        `â€¢ Äiá»n "ChÆ°a ná»™p" sau deadline\n\n` +
        `âš ï¸ ChÆ°a cÃ³ FormLib - Äá»‘i soÃ¡t checkbox chÆ°a Ä‘Æ°á»£c kÃ­ch hoáº¡t\n` +
        `ThÃªm Library "FormLib" Ä‘á»ƒ báº­t tÃ­nh nÄƒng nÃ y.`;
    
    SpreadsheetApp.getUi().alert(message);
    
  } catch (e) {
    Logger.log("âŒ Lá»—i: " + e.message);
    SpreadsheetApp.getUi().alert("âŒ Lá»—i: " + e.message);
  }
}

// ==================================================================
// CONFIG MANAGER - Äá»ŒC Cáº¤U HÃŒNH Tá»ª SHEET
// ==================================================================

const CONFIG_SHEET_NAME = "Cáº¥u HÃ¬nh";

const CONFIG_COL = {
  NAME: 0,
  CLASS_TIME: 1,
  START_TIME: 2,
  DEADLINE: 3,
  AUTO_CLEAN: 4,
  SHEET_NAME: 5
};

class ConfigManager {
  constructor() {
    this.configs = [];
    this.configSheet = null;
    
    this.COL = CONFIG_COL;
  }

  loadAll() {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    this.configSheet = ss.getSheetByName(CONFIG_SHEET_NAME);
    
    if (!this.configSheet) {
      throw new Error('KhÃ´ng tÃ¬m tháº¥y sheet "Cáº¥u HÃ¬nh". Vui lÃ²ng táº¡o sheet nÃ y trÆ°á»›c.');
    }

    const lastRow = this.configSheet.getLastRow();
    if (lastRow < 2) {
      Logger.log("Sheet Cáº¥u HÃ¬nh trá»‘ng, khÃ´ng cÃ³ config nÃ o.");
      return;
    }

    const dataRange = this.configSheet.getRange(2, 1, lastRow - 1, 6);
    const rows = dataRange.getValues();
    
    // Äá»c cleanup options tá»« Script Properties (chung cho táº¥t cáº£)
    const cleanupOpts = this.getCleanupOptions();

    this.configs = [];
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const name = String(row[this.COL.NAME] || "").trim();
      const classTimeStr = String(row[this.COL.CLASS_TIME] || "").trim();
      const startTimeStr = String(row[this.COL.START_TIME] || "").trim();
      const deadlineStr = String(row[this.COL.DEADLINE] || "").trim();
      const autoClean = row[this.COL.AUTO_CLEAN] === true;
      const sheetName = String(row[this.COL.SHEET_NAME] || "").trim();

      if (!name) continue;

      const isAttendance = (name.toLowerCase() === "Ä‘iá»ƒm danh");

      const config = {
        name: name,
        isAttendance: isAttendance,
        classSchedules: this.parseMultiSchedule(classTimeStr),
        startTime: startTimeStr ? this.parseTimeString(startTimeStr) : null,
        deadline: deadlineStr ? this.parseTimeString(deadlineStr) : null,
        autoClean: autoClean,
        sheetName: sheetName,
        cleanupOptions: cleanupOpts  // DÃ¹ng chung tá»« Script Properties
      };

      this.configs.push(config);
      Logger.log(`Loaded config: ${name} (${sheetName})`);
    }
  }

  getCleanupOptions() {
    const props = PropertiesService.getScriptProperties();
    return {
      clearEmails: props.getProperty('CLEANUP_CLEAR_EMAILS') !== 'false',
      clearFormResponses: props.getProperty('CLEANUP_CLEAR_RESPONSES') !== 'false',
      clearComments: props.getProperty('CLEANUP_CLEAR_COMMENTS') !== 'false'
    };
  }

  parseMultiSchedule(str) {
    if (!str) return [];
    
    const parts = str.split(/[;,]/).map(s => s.trim()).filter(s => s);
    const schedules = [];

    for (const part of parts) {
      const parsed = this.parseTimeString(part);
      if (parsed) {
        schedules.push(parsed);
      }
    }

    return schedules;
  }

  parseTimeString(str) {
    if (!str) return null;
    
    // Há»— trá»£ CN (Chá»§ Nháº­t) hoáº·c T1-T7 (Thá»© 2-Thá»© 7 + Chá»§ Nháº­t)
    const regex = /^(CN|T[1-7])-(\d{1,2}):(\d{2})$/;
    const match = str.match(regex);
    
    if (!match) {
      Logger.log(`âš ï¸ Format thá»i gian khÃ´ng há»£p lá»‡: "${str}". Mong Ä‘á»£i: CN-18:00, T1-18:00, T2-18:00, ..., T7-18:00 (ngÄƒn cÃ¡ch bá»Ÿi ; hoáº·c ,)`);
      return null;
    }

    // Chuyá»ƒn Ä‘á»•i CN/T1-T7 thÃ nh sá»‘ 0-6 (0=CN/T1, 1=T2, ..., 6=T7)
    let dayNum;
    if (match[1] === 'CN') {
      dayNum = 0;  // Chá»§ Nháº­t
    } else {
      const tNum = parseInt(match[1].substring(1));
      dayNum = tNum - 1;  // T1->0, T2->1, T3->2, ..., T7->6
    }
    
    const hour = parseInt(match[2]);
    const minute = parseInt(match[3]);

    if (dayNum < 0 || dayNum > 6) {
      Logger.log(`âš ï¸ NgÃ y khÃ´ng há»£p lá»‡: ${match[1]}. Pháº£i lÃ  CN/T1-T7`);
      return null;
    }

    return {
      dayOfWeek: dayNum,
      hour: hour,
      minute: minute
    };
  }

  getAll() {
    if (this.configs.length === 0) {
      this.loadAll();
    }
    return this.configs;
  }

  getByName(name) {
    return this.getAll().find(c => c.name.toLowerCase() === name.toLowerCase());
  }

  getAllSheetNames() {
    return this.getAll()
      .filter(c => c.sheetName && !c.isAttendance)
      .map(c => c.sheetName);
  }

  getSheetsForCleanup(dayOfWeek) {
    const sheetsWithOptions = [];
    const configs = this.getAll();

    for (const config of configs) {
      if (!config.autoClean || !config.sheetName) continue;

      const hasClassOnThisDay = config.classSchedules.some(schedule => {
        return schedule.dayOfWeek === dayOfWeek;
      });

      if (hasClassOnThisDay) {
        sheetsWithOptions.push({
          sheetName: config.sheetName,
          cleanupOptions: config.cleanupOptions
        });
      }
    }

    return sheetsWithOptions;
  }

  getSheetsForDeadline(dayOfWeek) {
    const sheets = [];
    const configs = this.getAll();

    for (const config of configs) {
      if (!config.deadline || !config.sheetName) continue;

      if (config.deadline.dayOfWeek === dayOfWeek) {
        sheets.push({
          sheetName: config.sheetName,
          config: config
        });
      }
    }

    return sheets;
  }
}

// ==================================================================
// HÃ€M PUBLIC - ÄÆ¯á»¢C Gá»ŒI Tá»ª SHEET SCRIPT
// ==================================================================

/**
 * HÃ m onEdit - Xá»­ lÃ½ khi edit trá»±c tiáº¿p trong sheet
 * Gá»ŒI Tá»ª SHEET: SheetLib.onEdit(e)
 */
function onEdit(e) {
  const range = e.range;
  const value = e.value;
  const row = range.getRow();
  const column = range.getColumn();
  const sheet = range.getSheet();

  // ----- 1.1: Xá»¬ LÃ ÄIá»‚M Sá» á» Cá»˜T C (Cá»™t 3) -----
  if (column == 3 && row >= 2) {
    if (value === undefined || value === null || value === "") return;
    if (typeof value === 'string' && value.toLowerCase().trim() === 'chÆ°a Ä‘áº¡t') {
      range.setValue("ChÆ°a Ä‘áº¡t");
      return;
    }
    let numericValue;
    if (typeof value === 'string') {
      numericValue = parseFloat(value.replace(',', '.'));
    } else {
      numericValue = value;
    }
    if (!isNaN(numericValue) && numericValue < 5) {
      range.setValue("ChÆ°a Ä‘áº¡t");
    }
    return;
  }

  // ----- 1.2: TÃ” MÃ€U HÃ€NG Dá»°A VÃ€O Cá»˜T F (Cá»™t 6 - Ghi chÃº) -----
  if (column === 6 && row >= 2) {
    const note = range.getValue();
    const coloringRange = sheet.getRange(row, 1, 1, sheet.getLastColumn());

    if (typeof note === 'string' && note.trim() !== '') {
      const lowerNote = note.toLowerCase();
      const hasNotSubmitted = lowerNote.includes('khÃ´ng ná»™p') || lowerNote.includes('chÆ°a ná»™p');
      const hasLate = lowerNote.includes('ná»™p muá»™n');
      const hasPermission = lowerNote.includes('xin phÃ©p') || lowerNote.includes('cÃ³ phÃ©p');
      const hasWrong = lowerNote.includes('ná»™p nháº§m');

      if (hasNotSubmitted && hasPermission) {
        coloringRange.setBackground('#f9cb9c');
      }
      else if (hasNotSubmitted) {
        coloringRange.setBackground('#f6b26b');
      }
      else if (hasLate && hasPermission) {
        coloringRange.setBackground('#fff2cc');
      }
      else if (hasLate || hasWrong) {
        coloringRange.setBackground('#cccccc');
      }
      else {
        coloringRange.setBackground(null);
      }
    } else {
      coloringRange.setBackground(null);
    }
  }

  // ----- 1.3: Sá»¬A Tá»ª NGá»® (KÃ©m, Yáº¿u, áº¨u) -----
  if (typeof value === 'string') {
    if (value.includes("kÃ©m") || value.includes("yáº¿u")) {
      var newValue = value.replace(/kÃ©m/g, "chÆ°a tá»‘t").replace(/yáº¿u/g, "chÆ°a tá»‘t");
      range.setValue(newValue);
    }
    if (value.includes("KÃ©m") || value.includes("Yáº¿u")) {
      var newValue = value.replace(/KÃ©m/g, "ChÆ°a tá»‘t").replace(/Yáº¿u/g, "ChÆ°a tá»‘t");
      range.setValue(newValue);
    }
    if (value.includes("KÃ‰M") || value.includes("Yáº¾U")) {
      var newValue = value.replace(/KÃ‰M/g, "CHÆ¯A Tá»T").replace(/Yáº¾U/g, "CHÆ¯A Tá»T");
      range.setValue(newValue);
    }
    if (value.includes("áº©u")) {
      var newValue = value.replace(/áº©u/g, "chÆ°a cáº©n tháº­n");
      range.setValue(newValue);
    }
    if (value.includes("áº¨u")) {
      var newValue = value.replace(/áº¨u/g, "ChÆ°a cáº©n tháº­n");
      range.setValue(newValue);
    }
  }

  // ----- 1.4: Äá»ŠNH Dáº NG Tá»° Äá»˜NG Gáº CH Äáº¦U DÃ’NG Cá»˜T D, E (Cá»™t 4, 5) - CHá»ˆ á» TRANG NHáº¬N XÃ‰T -----
  if ((column === 4 || column === 5) && row >= 2) {
    const sheetName = sheet.getName();
    // Chá»‰ Ã¡p dá»¥ng náº¿u tÃªn sheet chá»©a tá»« "Nháº­n xÃ©t" (khÃ´ng phÃ¢n biá»‡t hoa thÆ°á»ng)
    const isReviewSheet = sheetName.toLowerCase().includes('nháº­n xÃ©t');
    
    if (isReviewSheet) {
      const originalValue = range.getValue();

      if (typeof originalValue === 'string' && originalValue.trim() !== '') {
        const sentences = originalValue.replace(/\n/g, '.').split('.').filter(s => s.trim().length > 0);

        const formattedSentences = sentences.map(sentence => {
          let cleanSentence = sentence.trim();
          if (cleanSentence.startsWith('-')) {
            cleanSentence = cleanSentence.substring(1).trim();
          }
          return '- ' + cleanSentence.charAt(0).toUpperCase() + cleanSentence.slice(1);
        });

        const newValue = formattedSentences.join('.\n') + '.';

        if (newValue !== originalValue) {
          range.setValue(newValue);
        }
      }
    }
  }

  // ----- 1.5: Tá»° Äá»˜NG VIáº¾T HOA CHá»® CÃI Äáº¦U CÃ‚U (CÃ¡c cá»™t khÃ¡c) -----
  if (column !== 3 && column !== 4 && column !== 5) {
    let currentValue = range.getValue();
    if (typeof currentValue === 'string' && currentValue.length > 0) {
      const trimmedValue = currentValue.trim();
      const capitalizedValue = trimmedValue.charAt(0).toUpperCase() + trimmedValue.slice(1);
      if (capitalizedValue !== currentValue) {
        range.setValue(capitalizedValue);
      }
    }
  }
}

/**
 * Táº¡o menu tÃ¹y chá»‰nh
 * Gá»ŒI Tá»ª SHEET: SheetLib.onOpen()
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  
  ui.createMenu('Tiá»‡n Ã­ch Lá»›p Há»c')
    .addItem('âš™ï¸ CÃ i Ä‘áº·t ToÃ n bá»™ Lá»‹ch trÃ¬nh', 'SheetLib.setupSystemTriggers')
    .addSeparator()
    .addItem('ğŸ“ Cháº¡y thá»§ cÃ´ng: Äiá»n "ChÆ°a ná»™p"', 'SheetLib.manualFillNotAchieved')
    .addItem('ğŸ§¹ Cháº¡y thá»§ cÃ´ng: Dá»n dáº¹p (TÃ¹y chá»n)', 'SheetLib.showCleanupDialog')
    .addItem('ğŸ”„ Cháº¡y thá»§ cÃ´ng: Äá»‘i soÃ¡t Checkbox', 'reconcileCheckboxes')
    .addSeparator()
    .addItem('ğŸ“Š Xem cáº¥u hÃ¬nh hiá»‡n táº¡i', 'SheetLib.showCurrentConfig')
    .addItem('â„¹ï¸ HÆ°á»›ng dáº«n Setup láº§n Ä‘áº§u', 'SheetLib.showFirstTimeSetupGuide')
    .addToUi();
  
  const triggers = ScriptApp.getProjectTriggers();
  if (triggers.length === 0) {
    SpreadsheetApp.getActiveSpreadsheet().toast(
      'ğŸ’¡ Nháº¥n menu "Tiá»‡n Ã­ch Lá»›p Há»c" â†’ "CÃ i Ä‘áº·t ToÃ n bá»™ Lá»‹ch trÃ¬nh" Ä‘á»ƒ kÃ­ch hoáº¡t tá»± Ä‘á»™ng hÃ³a!',
      'âœ¨ Lá»›p má»›i Ä‘Æ°á»£c táº¡o thÃ nh cÃ´ng!',
      10
    );
  }
}

/**
 * Hiá»ƒn thá»‹ cáº¥u hÃ¬nh hiá»‡n táº¡i
 * Gá»ŒI Tá»ª MENU: SheetLib.showCurrentConfig()
 */
function showCurrentConfig() {
  const ui = SpreadsheetApp.getUi();
  const configMgr = new ConfigManager();
  
  try {
    configMgr.loadAll();
    const configs = configMgr.getAll();
    
    if (configs.length === 0) {
      ui.alert('KhÃ´ng cÃ³ cáº¥u hÃ¬nh nÃ o trong sheet "Cáº¥u HÃ¬nh".');
      return;
    }

    let message = 'ğŸ“‹ Cáº¤U HÃŒNH HIá»†N Táº I:\n\n';
    
    for (const config of configs) {
      message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
      message += `ğŸ“Œ ${config.name}\n`;
      message += `   Sheet: ${config.sheetName || "(khÃ´ng cÃ³)"}\n`;
      
      if (config.classSchedules.length > 0) {
        const scheduleStr = config.classSchedules
          .map(s => {
            const day = s.dayOfWeek === 0 ? 'CN' : `T${s.dayOfWeek + 1}`;
            return `${day}-${String(s.hour).padStart(2,'0')}:${String(s.minute).padStart(2,'0')}`;
          })
          .join(', ');
        message += `   Lá»‹ch há»c: ${scheduleStr}\n`;
      }
      
      if (config.deadline) {
        const d = config.deadline;
        const day = d.dayOfWeek === 0 ? 'CN' : `T${d.dayOfWeek + 1}`;
        message += `   Deadline: ${day}-${String(d.hour).padStart(2,'0')}:${String(d.minute).padStart(2,'0')}\n`;
      }
      
      message += `   Tá»± Ä‘á»™ng dá»n: ${config.autoClean ? 'âœ“' : 'âœ—'}\n`;
    }

    message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    message += `\nTá»•ng cá»™ng: ${configs.length} cáº¥u hÃ¬nh`;
    
    ui.alert(message);
  } catch (e) {
    ui.alert('Lá»—i', 'KhÃ´ng thá»ƒ Ä‘á»c cáº¥u hÃ¬nh: ' + e.message, ui.ButtonSet.OK);
  }
}

/**
 * Hiá»ƒn thá»‹ hÆ°á»›ng dáº«n setup láº§n Ä‘áº§u
 * Gá»ŒI Tá»ª MENU: SheetLib.showFirstTimeSetupGuide()
 */
function showFirstTimeSetupGuide() {
  const ui = SpreadsheetApp.getUi();
  
  const guide = `
ğŸ“š HÆ¯á»šNG DáºªN SETUP Láº¦N Äáº¦U

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… BÆ¯á»šC 1: ThÃªm loáº¡i bÃ i táº­p
   â†’ VÃ o sheet "Cáº¥u HÃ¬nh"
   â†’ ThÃªm dÃ²ng má»›i vá»›i thÃ´ng tin:
      â€¢ Cá»™t A: TÃªn bÃ i táº­p (VD: "Äáº¡i sá»‘")
      â€¢ Cá»™t B: Lá»‹ch há»c (VD: "CN-18:00;T6-09:00")
      â€¢ Cá»™t C: Thá»i gian má»Ÿ (VD: "T2-06:00")
      â€¢ Cá»™t D: Deadline (VD: "T3-23:00")
      â€¢ Cá»™t E: TÃ­ch checkbox náº¿u muá»‘n tá»± Ä‘á»™ng dá»n
      â€¢ Cá»™t F: TÃªn sheet tÆ°Æ¡ng á»©ng

âœ… BÆ¯á»šC 2: KÃ­ch hoáº¡t tá»± Ä‘á»™ng hÃ³a
   â†’ Menu "Tiá»‡n Ã­ch Lá»›p Há»c" 
   â†’ Chá»n "âš™ï¸ CÃ i Ä‘áº·t ToÃ n bá»™ Lá»‹ch trÃ¬nh"
   â†’ Cáº¥p quyá»n khi Ä‘Æ°á»£c yÃªu cáº§u

âœ… BÆ¯á»šC 3: LiÃªn káº¿t vá»›i Form
   â†’ Má»Ÿ Form cá»§a lá»›p
   â†’ Tools â†’ Script editor
   â†’ Cháº¡y hÃ m onFormSubmit test
   â†’ Cáº¥p quyá»n khi Ä‘Æ°á»£c yÃªu cáº§u

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’¡ Máº¸O:
â€¢ Xem cáº¥u hÃ¬nh: Menu â†’ "ğŸ“Š Xem cáº¥u hÃ¬nh hiá»‡n táº¡i"
â€¢ Format thá»i gian: CN=Chá»§ Nháº­t, T2=Thá»© 2, ..., T7=Thá»© 7
â€¢ Multi-schedule: DÃ¹ng dáº¥u ; hoáº·c ,

â“ CÃ³ tháº¯c máº¯c? Kiá»ƒm tra comments trong code!
  `;
  
  ui.alert('HÆ°á»›ng dáº«n Setup', guide, ui.ButtonSet.OK);
}

/**
 * CÃ i Ä‘áº·t triggers tá»± Ä‘á»™ng
 * Gá»ŒI Tá»ª MENU: SheetLib.setupSystemTriggers()
 */
/**
 * Setup triggers nhanh (gá»i tá»« quickSetupSheet)
 * Tá»± Ä‘á»™ng cÃ i Ä‘áº·t táº¥t cáº£ triggers cáº§n thiáº¿t mÃ  khÃ´ng cáº§n confirm
 */
function setupSystemTriggersQuick() {
  const configMgr = new ConfigManager();
  
  try {
    configMgr.loadAll();
    const configs = configMgr.getAll();
    
    if (configs.length === 0) {
      Logger.log('âš ï¸ Sheet "Cáº¥u HÃ¬nh" trá»‘ng - Chá»‰ táº¡o trigger Ä‘á»‘i soÃ¡t');
    }

    // XÃ³a táº¥t cáº£ triggers cÅ©
    const triggers = ScriptApp.getProjectTriggers();
    for (let i = 0; i < triggers.length; i++) {
      ScriptApp.deleteTrigger(triggers[i]);
    }
    Logger.log(`ğŸ—‘ï¸ ÄÃ£ xÃ³a ${triggers.length} triggers cÅ©`);

    let createdCount = 0;

    // 1. Táº O TRIGGER Äá»I SOÃT CHECKBOX TRÆ¯á»šC TIÃŠN (náº¿u cÃ³ FormLib)
    if (typeof FormLib !== 'undefined') {
      ScriptApp.newTrigger('runScheduledReconcile')
        .timeBased()
        .everyHours(1)
        .create();
      
      Logger.log(`ğŸ”„ Äá»‘i soÃ¡t checkbox: Má»—i 1 giá»`);
      createdCount++;
    } else {
      Logger.log(`âš ï¸ Bá» qua trigger Ä‘á»‘i soÃ¡t - ChÆ°a cÃ³ FormLib`);
    }

    // 2. Táº¡o triggers cleanup
    const cleanupSchedules = new Map();
    
    for (const config of configs) {
      if (!config.autoClean || config.classSchedules.length === 0) continue;
      
      for (const schedule of config.classSchedules) {
        const day = schedule.dayOfWeek;
        const cleanupHour = schedule.hour > 0 ? schedule.hour - 1 : 23;
        
        if (!cleanupSchedules.has(day)) {
          cleanupSchedules.set(day, new Set());
        }
        cleanupSchedules.get(day).add(cleanupHour);
      }
    }

    for (const [dayOfWeek, hours] of cleanupSchedules) {
      for (const hour of hours) {
        const weekday = convertDayOfWeekToScriptAppWeekDay(dayOfWeek);
        
        ScriptApp.newTrigger('runScheduledCleanup')
          .timeBased()
          .onWeekDay(weekday)
          .atHour(hour)
          .nearMinute(45)
          .create();
        
        const dayLabel = dayOfWeek === 0 ? 'CN' : `T${dayOfWeek + 1}`;
        Logger.log(`ğŸ§¹ Cleanup: ${dayLabel} ${hour}:45`);
        createdCount++;
      }
    }

    // 3. Táº¡o triggers deadline
    const deadlineSchedules = new Map();
    
    for (const config of configs) {
      if (!config.deadline) continue;
      
      const day = config.deadline.dayOfWeek;
      const deadlineHour = config.deadline.hour;
      const adjustedMinute = config.deadline.minute + 30;
      const finalHour = adjustedMinute >= 60 ? (deadlineHour + 1) % 24 : deadlineHour;
      
      if (!deadlineSchedules.has(day)) {
        deadlineSchedules.set(day, new Set());
      }
      deadlineSchedules.get(day).add(finalHour);
    }

    for (const [dayOfWeek, hours] of deadlineSchedules) {
      for (const hour of hours) {
        const weekday = convertDayOfWeekToScriptAppWeekDay(dayOfWeek);
        
        ScriptApp.newTrigger('runScheduledDeadline')
          .timeBased()
          .onWeekDay(weekday)
          .atHour(hour)
          .nearMinute(0)
          .create();
        
        const dayLabel = dayOfWeek === 0 ? 'CN' : `T${dayOfWeek + 1}`;
        Logger.log(`ğŸ“ Deadline: ${dayLabel} ${hour}:00`);
        createdCount++;
      }
    }

    Logger.log(`\nâœ… Tá»•ng cá»™ng: ${createdCount} triggers Ä‘Ã£ Ä‘Æ°á»£c táº¡o`);
    
  } catch (e) {
    Logger.log('âŒ Lá»—i setupSystemTriggersQuick: ' + e.toString());
    throw e;
  }
}

/**
 * Setup triggers vá»›i confirm dialog
 * Gá»ŒI Tá»ª MENU: Tiá»‡n Ã­ch Lá»›p Há»c â†’ CÃ i Ä‘áº·t ToÃ n bá»™ Lá»‹ch trÃ¬nh
 */
function setupSystemTriggers() {
  const ui = SpreadsheetApp.getUi();
  const configMgr = new ConfigManager();
  
  try {
    configMgr.loadAll();
    const configs = configMgr.getAll();
    
    if (configs.length === 0) {
      ui.alert('Sheet "Cáº¥u HÃ¬nh" trá»‘ng hoáº·c khÃ´ng tá»“n táº¡i. Vui lÃ²ng táº¡o cáº¥u hÃ¬nh trÆ°á»›c.');
      return;
    }

    const triggers = ScriptApp.getProjectTriggers();
    for (let i = 0; i < triggers.length; i++) {
      ScriptApp.deleteTrigger(triggers[i]);
    }

    let createdCount = 0;
    let message = 'âœ… ÄÃƒ CÃ€I Äáº¶T TRIGGERS:\n\n';

    const cleanupSchedules = new Map();
    
    for (const config of configs) {
      if (!config.autoClean || config.classSchedules.length === 0) continue;
      
      for (const schedule of config.classSchedules) {
        const day = schedule.dayOfWeek;
        const cleanupHour = schedule.hour > 0 ? schedule.hour - 1 : 23;
        
        if (!cleanupSchedules.has(day)) {
          cleanupSchedules.set(day, new Set());
        }
        cleanupSchedules.get(day).add(cleanupHour);
      }
    }

    for (const [dayOfWeek, hours] of cleanupSchedules) {
      for (const hour of hours) {
        const weekday = convertDayOfWeekToScriptAppWeekDay(dayOfWeek);
        
        ScriptApp.newTrigger('SheetLib.runScheduledCleanup')
          .timeBased()
          .onWeekDay(weekday)
          .atHour(hour)
          .nearMinute(45)
          .create();
        
        const dayLabel = dayOfWeek === 0 ? 'CN' : `T${dayOfWeek + 1}`;
        message += `ğŸ§¹ Cleanup: ${dayLabel} ${hour}:45\n`;
        createdCount++;
      }
    }

    const deadlineSchedules = new Map();
    
    for (const config of configs) {
      if (!config.deadline) continue;
      
      const day = config.deadline.dayOfWeek;
      const deadlineHour = config.deadline.hour;
      const adjustedMinute = config.deadline.minute + 30;
      const finalHour = adjustedMinute >= 60 ? (deadlineHour + 1) % 24 : deadlineHour;
      
      if (!deadlineSchedules.has(day)) {
        deadlineSchedules.set(day, new Set());
      }
      deadlineSchedules.get(day).add(finalHour);
    }

    for (const [dayOfWeek, hours] of deadlineSchedules) {
      for (const hour of hours) {
        const weekday = convertDayOfWeekToScriptAppWeekDay(dayOfWeek);
        
        ScriptApp.newTrigger('SheetLib.runScheduledDeadline')
          .timeBased()
          .onWeekDay(weekday)
          .atHour(hour)
          .nearMinute(0)
          .create();
        
        const dayLabel = dayOfWeek === 0 ? 'CN' : `T${dayOfWeek + 1}`;
        message += `ğŸ“ Deadline: ${dayLabel} ${hour}:00\n`;
        createdCount++;
      }
    }

    // Táº¡o trigger Ä‘á»‘i soÃ¡t checkbox (má»—i 1 giá») náº¿u cÃ³ FormLib
    if (typeof FormLib !== 'undefined') {
      ScriptApp.newTrigger('SheetLib.runScheduledReconcile')
        .timeBased()
        .everyHours(1)
        .create();
      
      message += `ğŸ”„ Äá»‘i soÃ¡t checkbox: Má»—i 1 giá»\n`;
      createdCount++;
    }

    message += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    message += `Tá»•ng cá»™ng: ${createdCount} triggers\n`;
    message += `(Dá»±a trÃªn ${configs.length} cáº¥u hÃ¬nh)`;
    
    ui.alert('ThÃ nh cÃ´ng!', message, ui.ButtonSet.OK);
    
  } catch (e) {
    ui.alert('Lá»—i', 'KhÃ´ng thá»ƒ cÃ i Ä‘áº·t triggers: ' + e.message, ui.ButtonSet.OK);
    Logger.log('Error in setupSystemTriggers: ' + e.toString());
  }
}

/**
 * Cháº¡y cleanup theo lá»‹ch
 * Gá»ŒI Tá»ª TRIGGER: SheetLib.runScheduledCleanup()
 */
function runScheduledCleanup() {
  const now = new Date();
  const currentDay = now.getDay() === 0 ? 1 : now.getDay() + 1;
  
  const configMgr = new ConfigManager();
  configMgr.loadAll();
  
  const sheetsWithOptions = configMgr.getSheetsForCleanup(currentDay);
  
  if (sheetsWithOptions.length > 0) {
    // Dá»n tá»«ng sheet vá»›i options riÃªng
    sheetsWithOptions.forEach(item => {
      cleanSheets([item.sheetName], item.cleanupOptions);
      Logger.log(`  - ${item.sheetName}: Email=${item.cleanupOptions.clearEmails}, Responses=${item.cleanupOptions.clearFormResponses}, Comments=${item.cleanupOptions.clearComments}`);
    });
    Logger.log(`Cleaned ${sheetsWithOptions.length} sheets on day ${currentDay}`);
  }
}

/**
 * Äiá»n "ChÆ°a ná»™p" sau deadline
 * Gá»ŒI Tá»ª TRIGGER: SheetLib.runScheduledDeadline()
 */
function runScheduledDeadline() {
  const now = new Date();
  const currentDay = now.getDay() === 0 ? 1 : now.getDay() + 1;
  
  const configMgr = new ConfigManager();
  configMgr.loadAll();
  
  const sheetsForDeadline = configMgr.getSheetsForDeadline(currentDay);
  
  if (sheetsForDeadline.length > 0) {
    const sheetNames = sheetsForDeadline.map(s => s.sheetName);
    fillMissingMarks(sheetNames);
    Logger.log(`Filled "ChÆ°a ná»™p" for ${sheetNames.length} sheets on day ${currentDay}`);
  }
}

/**
 * Äá»‘i soÃ¡t checkbox Ä‘á»‹nh ká»³ (má»—i 1 giá»)
 * Gá»ŒI Tá»ª TRIGGER: SheetLib.runScheduledReconcile()
 * 
 * Chá»©c nÄƒng:
 * - QuÃ©t táº¥t cáº£ folders bÃ i táº­p trÃªn Drive
 * - So sÃ¡nh vá»›i danh sÃ¡ch há»c sinh trong Sheet
 * - Tá»± Ä‘á»™ng tick checkbox cho há»c sinh Ä‘Ã£ ná»™p nhÆ°ng chÆ°a Ä‘Ã¡nh dáº¥u
 */
function runScheduledReconcile() {
  try {
    Logger.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
    Logger.log(`ğŸ”„ Báº®T Äáº¦U Äá»I SOÃT Äá»ŠNH Ká»²`);
    Logger.log(`â° Thá»i gian: ${new Date().toLocaleString('vi-VN')}`);
    Logger.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
    
    // Kiá»ƒm tra FormLib cÃ³ tá»“n táº¡i khÃ´ng
    if (typeof FormLib === 'undefined') {
      Logger.log('âš ï¸ KHÃ”NG TÃŒM THáº¤Y FormLib - Bá» qua Ä‘á»‘i soÃ¡t');
      Logger.log('ğŸ’¡ ThÃªm Library "FormLib" vÃ o project Ä‘á»ƒ kÃ­ch hoáº¡t tÃ­nh nÄƒng nÃ y');
      return;
    }
    
    // Láº¥y Class Folder ID tá»« cell I3
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const configSheet = ss.getSheetByName('Cáº¥u HÃ¬nh');
    
    if (!configSheet) {
      Logger.log('âŒ KhÃ´ng tÃ¬m tháº¥y sheet "Cáº¥u HÃ¬nh"');
      return;
    }
    
    const classFolderId = configSheet.getRange('I3').getValue();
    
    if (!classFolderId) {
      Logger.log('âš ï¸ ChÆ°a cÃ³ Class Folder ID trong cell I3');
      Logger.log('ğŸ’¡ Cháº¡y "Äá»“ng bá»™ & LiÃªn káº¿t" trÃªn web app Ä‘á»ƒ thiáº¿t láº­p');
      return;
    }
    
    Logger.log(`ğŸ“ Class Folder ID: ${classFolderId}`);
    
    // Gá»i FormLib Ä‘á»ƒ thá»±c hiá»‡n Ä‘á»‘i soÃ¡t
    FormLib.reconcileCheckboxes(classFolderId);
    
    Logger.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
    Logger.log(`âœ… Äá»I SOÃT HOÃ€N Táº¤T`);
    Logger.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`);
    
  } catch (e) {
    Logger.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
    Logger.log(`âŒ Lá»–I Äá»I SOÃT: ${e.message}`);
    Logger.log(`Stack: ${e.stack}`);
    Logger.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`);
  }
}

/**
 * Hiá»ƒn thá»‹ dialog cáº¥u hÃ¬nh tÃ¹y chá»n tá»± Ä‘á»™ng dá»n dáº¹p
 * Gá»ŒI Tá»ª MENU: SheetLib.showCleanupDialog()
 */
function showCleanupDialog() {
  // Äá»c config hiá»‡n táº¡i
  const props = PropertiesService.getScriptProperties();
  const clearEmails = props.getProperty('CLEANUP_CLEAR_EMAILS') !== 'false';
  const clearResponses = props.getProperty('CLEANUP_CLEAR_RESPONSES') !== 'false';
  const clearComments = props.getProperty('CLEANUP_CLEAR_COMMENTS') !== 'false';
  
  const html = HtmlService.createHtmlOutput(`
    <!DOCTYPE html>
    <html>
      <head>
        <base target="_top">
        <style>
          body {
            font-family: Arial, sans-serif;
            padding: 20px;
            font-size: 14px;
          }
          h2 {
            margin-top: 0;
            color: #333;
          }
          .option {
            margin: 15px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
          }
          .option label {
            display: flex;
            align-items: center;
            cursor: pointer;
          }
          .option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
          }
          .button-container {
            margin-top: 25px;
            display: flex;
            gap: 10px;
          }
          button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
          }
          .btn-clean {
            background: #4CAF50;
            color: white;
          }
          .btn-clean:hover {
            background: #45a049;
          }
          .btn-cancel {
            background: #f44336;
            color: white;
          }
          .btn-cancel:hover {
            background: #da190b;
          }
          .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            color: #856404;
          }
        </style>
      </head>
      <body>
        <h2>âš™ï¸ Cáº¥u hÃ¬nh Tá»± Ä‘á»™ng Dá»n dáº¹p</h2>
        <p style="color: #666; margin-bottom: 15px;">Chá»n cÃ¡c má»¥c sáº½ Ä‘Æ°á»£c tá»± Ä‘á»™ng xÃ³a trÆ°á»›c giá» há»c:</p>
        
        <div class="option">
          <label>
            <input type="checkbox" id="clearEmails" ${clearEmails ? 'checked' : ''}>
            <span><strong>1ï¸âƒ£ XÃ³a Email thÃ´ng bÃ¡o</strong> (Cá»™t B - Gá»­i mail bÃ¡o lá»—i)</span>
          </label>
        </div>
        
        <div class="option">
          <label>
            <input type="checkbox" id="clearFormResponses" ${clearResponses ? 'checked' : ''}>
            <span><strong>2ï¸âƒ£ XÃ³a cÃ¢u tráº£ lá»i Form</strong> (Cá»™t C - Äiá»ƒm sá»‘)</span>
          </label>
        </div>
        
        <div class="option">
          <label>
            <input type="checkbox" id="clearComments" ${clearComments ? 'checked' : ''}>
            <span><strong>3ï¸âƒ£ XÃ³a Nháº­n xÃ©t</strong> (Cá»™t D, E, G - Æ¯u Ä‘iá»ƒm, NhÆ°á»£c Ä‘iá»ƒm & Checkbox)</span>
          </label>
        </div>
        
        <div class="warning">
          â„¹ï¸ <strong>LÆ°u Ã½:</strong> Cáº¥u hÃ¬nh nÃ y sáº½ Ã¡p dá»¥ng cho Táº¤T Cáº¢ bÃ i táº­p khi tá»± Ä‘á»™ng dá»n dáº¹p.
        </div>
        
        <div class="button-container">
          <button class="btn-clean" onclick="saveConfig()">ğŸ’¾ LÆ°u cáº¥u hÃ¬nh</button>
          <button class="btn-cancel" onclick="google.script.host.close()">âŒ Há»§y</button>
        </div>
        
        <script>
          function saveConfig() {
            const options = {
              clearEmails: document.getElementById('clearEmails').checked,
              clearFormResponses: document.getElementById('clearFormResponses').checked,
              clearComments: document.getElementById('clearComments').checked
            };
            
            google.script.run
              .withSuccessHandler(function() {
                alert('âœ… ÄÃ£ lÆ°u cáº¥u hÃ¬nh tá»± Ä‘á»™ng dá»n dáº¹p!');
                google.script.host.close();
              })
              .withFailureHandler(function(error) {
                alert('âŒ Lá»—i: ' + error);
              })
              .SheetLib.saveCleanupConfig(options);
          }
        </script>
      </body>
    </html>
  `)
  .setWidth(450)
  .setHeight(400);
  
  SpreadsheetApp.getUi().showModalDialog(html, 'Cáº¥u hÃ¬nh Tá»± Ä‘á»™ng Dá»n dáº¹p');
}

/**
 * LÆ°u cáº¥u hÃ¬nh cleanup vÃ o Script Properties (chung cho táº¥t cáº£ bÃ i táº­p)
 * Gá»ŒI Tá»ª DIALOG: SheetLib.saveCleanupConfig(options)
 */
function saveCleanupConfig(options) {
  const props = PropertiesService.getScriptProperties();
  
  props.setProperty('CLEANUP_CLEAR_EMAILS', String(options.clearEmails));
  props.setProperty('CLEANUP_CLEAR_RESPONSES', String(options.clearFormResponses));
  props.setProperty('CLEANUP_CLEAR_COMMENTS', String(options.clearComments));
  
  Logger.log(`ÄÃ£ lÆ°u cáº¥u hÃ¬nh cleanup vÃ o Script Properties: ${JSON.stringify(options)}`);
}

/**
 * Cháº¡y thá»§ cÃ´ng Ä‘iá»n "ChÆ°a ná»™p"
 * Gá»ŒI Tá»ª MENU: SheetLib.manualFillNotAchieved()
 */
function manualFillNotAchieved() {
  const ui = SpreadsheetApp.getUi();
  const configMgr = new ConfigManager();
  
  try {
    configMgr.loadAll();
    const allSheets = configMgr.getAll()
      .filter(c => c.sheetName)
      .map(c => c.sheetName);
    
    if (allSheets.length === 0) {
      ui.alert('KhÃ´ng cÃ³ sheet nÃ o trong cáº¥u hÃ¬nh.');
      return;
    }

    const response = ui.alert(
      'Äiá»n "ChÆ°a ná»™p"?', 
      `Há»‡ thá»‘ng sáº½ Ä‘iá»n "ChÆ°a ná»™p" vÃ o ${allSheets.length} sheets:\n${allSheets.join(', ')}\n\nTiáº¿p tá»¥c?`,
      ui.ButtonSet.YES_NO
    );
    
    if (response == ui.Button.YES) {
      fillMissingMarks(allSheets);
      ui.alert('âœ… HoÃ n táº¥t!');
    }
  } catch (e) {
    ui.alert('Lá»—i', e.message, ui.ButtonSet.OK);
  }
}

// ==================================================================
// HÃ€M INTERNAL - KHÃ”NG Gá»ŒI TRá»°C TIáº¾P Tá»ª BÃŠN NGOÃ€I
// ==================================================================

function fillMissingMarks(sheetNames) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  sheetNames.forEach(name => {
    const sheet = ss.getSheetByName(name);
    if (sheet && sheet.getLastRow() >= 2) {
      try {
        const range = sheet.getRange(2, 6, sheet.getLastRow() - 1, 2); 
        const values = range.getValues();
        let isChanged = false;

        for (let i = 0; i < values.length; i++) {
          const noteValue = values[i][0];
          const isChecked = values[i][1];

          if (isChecked !== true && (noteValue === "" || noteValue === null)) {
            values[i][0] = "ChÆ°a ná»™p";
            isChanged = true;
          }
        }

        if (isChanged) {
          range.setValues(values);
          Logger.log(`ÄÃ£ xá»­ lÃ½ Ä‘iá»n "ChÆ°a ná»™p" cho sheet: ${name}`);
        }
      } catch (e) {
        Logger.log(`Lá»—i Ä‘iá»n "ChÆ°a ná»™p" sheet ${name}: ${e.toString()}`);
      }
    }
  });
}

function cleanSheets(sheetNames, options = {}) {
  const defaultOptions = {
    clearEmails: true,
    clearFormResponses: true,
    clearComments: true
  };
  
  const opts = Object.assign({}, defaultOptions, options);
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  sheetNames.forEach(name => {
    const sheet = ss.getSheetByName(name);
    if (sheet) {
      try {
        // 1ï¸âƒ£ XÃ³a Email thÃ´ng bÃ¡o (Cá»™t B)
        if (opts.clearEmails) {
          sheet.getRange("B2:B").clearContent();
        }
        
        // 2ï¸âƒ£ XÃ³a cÃ¢u tráº£ lá»i Form / Äiá»ƒm sá»‘ (Cá»™t C)
        if (opts.clearFormResponses) {
          sheet.getRange("C2:C").clearContent();
        }
        
        // 3ï¸âƒ£ XÃ³a Nháº­n xÃ©t (Cá»™t D, E, G - bao gá»“m checkbox)
        if (opts.clearComments) {
          sheet.getRange("D2:E").clearContent();  // Æ¯u Ä‘iá»ƒm, NhÆ°á»£c Ä‘iá»ƒm
          sheet.getRange("G2:G").clearContent();  // Checkbox Ä‘Ã£ ná»™p
        }
        
        Logger.log(`ÄÃ£ dá»n dáº¹p sheet: ${name}`);
      } catch (e) {
        Logger.log(`Lá»—i dá»n dáº¹p sheet ${name}: ${e.toString()}`);
      }
    }
  });
}

function convertDayOfWeekToScriptAppWeekDay(dayOfWeek) {
  const mapping = {
    0: ScriptApp.WeekDay.SUNDAY,
    1: ScriptApp.WeekDay.MONDAY,
    2: ScriptApp.WeekDay.TUESDAY,
    3: ScriptApp.WeekDay.WEDNESDAY,
    4: ScriptApp.WeekDay.THURSDAY,
    5: ScriptApp.WeekDay.FRIDAY,
    6: ScriptApp.WeekDay.SATURDAY
  };
  return mapping[dayOfWeek] || ScriptApp.WeekDay.SUNDAY;
}
