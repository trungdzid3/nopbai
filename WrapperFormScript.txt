/**
 * ============================================================================
 * FORM TEMPLATE - WRAPPER SCRIPT
 * ============================================================================
 * 
 * Script n√†y ƒë∆∞·ª£c webapp t·ª± ƒë·ªông copy khi t·∫°o l·ªõp m·ªõi.
 * Code ch√≠nh n·∫±m trong Library "FormLib" - ch·ªâ c·∫ßn c·∫≠p nh·∫≠t library l√† ƒë·ªß!
 * 
 * Setup l·∫ßn ƒë·∫ßu:
 * 1. Resources ‚Üí Libraries
 * 2. Add library ‚Üí Paste Script ID c·ªßa LibraryFormScript
 * 3. Ch·ªçn phi√™n b·∫£n m·ªõi nh·∫•t
 * 4. Identifier: "FormLib" (QUAN TR·ªåNG - ph·∫£i ƒë√∫ng t√™n n√†y!)
 * 5. [T√ôY CH·ªåN] Email th√¥ng b√°o:
 *    - T·ª± ƒë·ªông: Webapp s·∫Ω ghi email ng∆∞·ªùi t·∫°o l·ªõp v√†o Sheet Config cell I6
 *    - Th·ªß c√¥ng: File ‚Üí Project properties ‚Üí Script properties
 *      ‚Üí Add: RECIPIENT_EMAIL = email kh√°c (n·∫øu c·∫ßn override)
 *    - Ho·∫∑c: Ghi tr·ª±c ti·∫øp v√†o Sheet "C·∫•u H√¨nh" cell I6
 * 
 * Khi c·∫ßn update logic:
 * - KH√îNG S·ª¨A FILE N√ÄY
 * - S·ª≠a LibraryFormScript ‚Üí Deploy phi√™n b·∫£n m·ªõi
 * - T·∫•t c·∫£ Form t·ª± ƒë·ªông d√πng code m·ªõi!
 * 
 * ============================================================================
 */

// ==================================================================
// TRIGGER FUNCTIONS - ƒê∆ØA G·ªåI T·ª™ FORM/TRIGGERS
// ==================================================================

/**
 * X·ª≠ l√Ω khi c√≥ submission m·ªõi
 * Trigger: On form submit
 */
function onFormSubmit(e) {
  // L·∫•y email t·ª´ nhi·ªÅu ngu·ªìn (∆∞u ti√™n: Script Properties > Sheet Config)
  let recipientEmail = PropertiesService.getScriptProperties().getProperty('RECIPIENT_EMAIL');
  
  // N·∫øu kh√¥ng c√≥ trong Script Properties, ƒë·ªçc t·ª´ Sheet Config
  if (!recipientEmail) {
    try {
      recipientEmail = getEmailFromSheetConfig();
    } catch (err) {
      Logger.log('‚ö†Ô∏è Kh√¥ng th·ªÉ ƒë·ªçc email t·ª´ Sheet Config: ' + err.message);
    }
  }
  
  if (!recipientEmail) {
    Logger.log('‚ö†Ô∏è RECIPIENT_EMAIL ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t!');
    Logger.log('C√°ch 1: File ‚Üí Project properties ‚Üí Script properties ‚Üí Add: RECIPIENT_EMAIL');
    Logger.log('C√°ch 2: Ghi email v√†o Sheet "C·∫•u H√¨nh" cell I6 (Email qu·∫£n l√Ω)');
    return;
  }
  
  Logger.log(`üìß G·ª≠i th√¥ng b√°o t·ªõi: ${recipientEmail}`);
  
  // G·ªçi h√†m ch√≠nh t·ª´ library
  FormLib.onFormSubmit(e, recipientEmail);
}

/**
 * ƒê·ªçc email t·ª´ Sheet Config (cell I6)
 * Sheet ID ƒë∆∞·ª£c l·∫•y t·ª´ Script Properties (ƒë∆∞·ª£c webapp ghi khi t·∫°o l·ªõp)
 */
function getEmailFromSheetConfig() {
  try {
    // ∆Øu ti√™n 1: L·∫•y Sheet ID t·ª´ Script Properties (ƒë∆∞·ª£c webapp ghi khi t·∫°o l·ªõp)
    const scriptProperties = PropertiesService.getScriptProperties();
    let sheetId = scriptProperties.getProperty('SHEET_ID');
    
    // ∆Øu ti√™n 2: N·∫øu kh√¥ng c√≥, th·ª≠ l·∫•y t·ª´ form destination (n·∫øu ƒë√£ link)
    if (!sheetId) {
      const form = FormApp.getActiveForm();
      sheetId = form.getDestinationId();
    }
    
    if (!sheetId) {
      Logger.log('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y Sheet ID (ch∆∞a link form ho·∫∑c ch∆∞a c·∫•u h√¨nh Script Properties)');
      return null;
    }
    
    const ss = SpreadsheetApp.openById(sheetId);
    const configSheet = ss.getSheetByName('C·∫•u H√¨nh');
    
    if (!configSheet) {
      Logger.log('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y sheet "C·∫•u H√¨nh"');
      return null;
    }
    
    // ƒê·ªçc email t·ª´ cell I6 (c·ªôt 9, d√≤ng 6)
    const email = configSheet.getRange('I6').getValue();
    
    if (email && typeof email === 'string' && email.includes('@')) {
      Logger.log(`‚úÖ ƒê√£ l·∫•y email t·ª´ Sheet Config (I6): ${email}`);
      return email;
    }
    
    Logger.log('‚ö†Ô∏è Cell I6 kh√¥ng ch·ª©a email h·ª£p l·ªá');
    return null;
  } catch (e) {
    Logger.log('‚ùå L·ªói khi ƒë·ªçc email t·ª´ Sheet: ' + e.toString());
    return null;
  }
}

/**
 * Web app ƒë·ªÉ s·ª≠a email
 * Trigger: None (ƒë∆∞·ª£c g·ªçi t·ª´ link trong email)
 */
function doGet(e) {
  return FormLib.doGet(e);
}

/**
 * Cleanup v√† m·ªü form theo l·ªãch
 * Trigger: Time-based (ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông theo config)
 */
function runScheduledCleanupAndEnsureOpen() {
  FormLib.runScheduledCleanupAndEnsureOpen();
}

/**
 * Qu√©t v√† convert DOCX ƒë·ªãnh k·ª≥
 * Trigger: Time-based (30 ph√∫t 1 l·∫ßn)
 */
function periodicCleanup() {
  FormLib.periodicCleanup();
}

/**
 * ƒê·ªëi chi·∫øu checkbox gi·ªØa Drive v√† Sheet
 * Trigger: Time-based ho·∫∑c manual
 */
function reconcileCheckboxes() {
  FormLib.reconcileCheckboxes();
}

// ==================================================================
// SETUP FUNCTIONS - G·ªåI MANUAL L·∫¶N ƒê·∫¶U
// ==================================================================

/**
 * ‚ö° SETUP NHANH - CH·∫†Y H√ÄM N√ÄY 1 L·∫¶N SAU KHI T·∫†O FORM M·ªöI
 * T·ª± ƒë·ªông c√†i ƒë·∫∑t t·∫•t c·∫£ triggers c·∫ßn thi·∫øt
 */
function quickSetup() {
  try {
    Logger.log('üöÄ B·∫Øt ƒë·∫ßu Quick Setup...');
    
    // 0. T·ª± ƒë·ªông detect v√† l∆∞u Sheet ID
    const scriptProperties = PropertiesService.getScriptProperties();
    const form = FormApp.getActiveForm();
    let sheetId = scriptProperties.getProperty('SHEET_ID');
    
    if (!sheetId) {
      Logger.log('üîç ƒêang t·ª± ƒë·ªông t√¨m Sheet ID...');
      
      // Th·ª≠ 1: L·∫•y t·ª´ form destination (n·∫øu ƒë√£ link)
      try {
        sheetId = form.getDestinationId();
        
        if (sheetId) {
          scriptProperties.setProperty('SHEET_ID', sheetId);
          Logger.log(`‚úÖ ƒê√£ t·ª± ƒë·ªông l∆∞u Sheet ID t·ª´ form destination: ${sheetId}`);
        }
      } catch (e) {
        Logger.log(`‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y form destination: ${e.message}`);
      }
      
      // Th·ª≠ 2: T√¨m trong c√πng folder v·ªõi Form
      if (!sheetId) {
        try {
          const formFile = DriveApp.getFileById(form.getId());
          const formParents = formFile.getParents();
          
          if (formParents.hasNext()) {
            const folder = formParents.next();
            const files = folder.getFilesByType(MimeType.GOOGLE_SHEETS);
            
            while (files.hasNext()) {
              const file = files.next();
              // T√¨m file sheet c√≥ t√™n ch·ª©a "B·∫£ng nh·∫≠n x√©t"
              if (file.getName().includes('B·∫£ng nh·∫≠n x√©t')) {
                sheetId = file.getId();
                scriptProperties.setProperty('SHEET_ID', sheetId);
                Logger.log(`‚úÖ ƒê√£ t·ª± ƒë·ªông t√¨m v√† l∆∞u Sheet ID t·ª´ Drive: ${sheetId} (${file.getName()})`);
                break;
              }
            }
          }
        } catch (e) {
          Logger.log(`‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y Sheet trong folder: ${e.message}`);
        }
      }
      
      if (!sheetId) {
        Logger.log('‚ö†Ô∏è C·∫¢NH B√ÅO: Kh√¥ng t√¨m th·∫•y Sheet ID!');
        Logger.log('üí° Gi·∫£i ph√°p: File ‚Üí Project properties ‚Üí Script properties');
        Logger.log('   ‚Üí Add: SHEET_ID = [ID c·ªßa Sheet "B·∫£ng nh·∫≠n x√©t"]');
      }
    } else {
      Logger.log(`‚úÖ Sheet ID ƒë√£ c√≥: ${sheetId}`);
    }
    
    // 0.1. T·ª± ƒë·ªông link form v·ªõi sheet (n·∫øu ch∆∞a link)
    if (sheetId) {
      try {
        const currentDestination = form.getDestinationId();
        
        if (!currentDestination || currentDestination !== sheetId) {
          Logger.log('üîó ƒêang li√™n k·∫øt Form v·ªõi Sheet...');
          form.setDestination(FormApp.DestinationType.SPREADSHEET, sheetId);
          Logger.log('‚úÖ ƒê√£ t·ª± ƒë·ªông li√™n k·∫øt Form v·ªõi Sheet!');
        } else {
          Logger.log('‚úÖ Form ƒë√£ ƒë∆∞·ª£c li√™n k·∫øt v·ªõi Sheet');
        }
      } catch (e) {
        Logger.log(`‚ö†Ô∏è Kh√¥ng th·ªÉ t·ª± ƒë·ªông link form-sheet: ${e.message}`);
        Logger.log('üí° Gi·∫£i ph√°p: V√†o Form ‚Üí Responses ‚Üí Select response destination ‚Üí Ch·ªçn Sheet');
      }
    }
    
    // 1. X√≥a t·∫•t c·∫£ triggers c≈©
    const oldTriggers = ScriptApp.getProjectTriggers();
    oldTriggers.forEach(trigger => {
      ScriptApp.deleteTrigger(trigger);
      Logger.log(`üóëÔ∏è ƒê√£ x√≥a trigger c≈©: ${trigger.getHandlerFunction()}`);
    });
    
    // 2. T·∫°o Form Submit Trigger
    ScriptApp.newTrigger('onFormSubmit')
      .forForm(form)
      .onFormSubmit()
      .create();
    Logger.log('‚úÖ ƒê√£ t·∫°o trigger: onFormSubmit (On form submit)');
    
    // 3. T·∫°o Periodic Cleanup Trigger (30 ph√∫t)
    ScriptApp.newTrigger('periodicCleanup')
      .timeBased()
      .everyMinutes(30)
      .create();
    Logger.log('‚úÖ ƒê√£ t·∫°o trigger: periodicCleanup (Every 30 minutes)');
    
    // 4. T·∫°o Checkbox Reconciliation Trigger (1 gi·ªù)
    ScriptApp.newTrigger('reconcileCheckboxes')
      .timeBased()
      .everyHours(1)
      .create();
    Logger.log('‚úÖ ƒê√£ t·∫°o trigger: reconcileCheckboxes (Every 1 hour)');
    
    // 5. Ki·ªÉm tra email config
    let recipientEmail = scriptProperties.getProperty('RECIPIENT_EMAIL');
    
    if (!recipientEmail) {
      try {
        recipientEmail = getEmailFromSheetConfig();
        if (recipientEmail) {
          Logger.log(`üìß T√¨m th·∫•y email trong Sheet Config: ${recipientEmail}`);
        }
      } catch (err) {
        Logger.log(`‚ö†Ô∏è Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c email t·ª´ Sheet: ${err.message}`);
      }
    } else {
      Logger.log(`üìß Email ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t: ${recipientEmail}`);
    }
    
    if (!recipientEmail) {
      Logger.log('‚ö†Ô∏è C·∫¢NH B√ÅO: Ch∆∞a c√≥ email th√¥ng b√°o!');
      Logger.log('üí° H√£y ghi email v√†o Sheet "C·∫•u H√¨nh" cell I6');
    }
    
    // 6. Th·ª≠ setup scheduled cleanup (n·∫øu c√≥ config)
    try {
      setupScheduledCleanup();
      Logger.log('‚úÖ ƒê√£ c√†i ƒë·∫∑t scheduled cleanup triggers');
    } catch (err) {
      Logger.log(`‚ÑπÔ∏è Scheduled cleanup: ${err.message}`);
    }
    
    Logger.log('\nüéâ HO√ÄN T·∫§T QUICK SETUP!');
    Logger.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    Logger.log('üìã C√°c trigger ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t:');
    Logger.log('   1. onFormSubmit - Khi c√≥ h·ªçc sinh n·ªôp b√†i');
    Logger.log('   2. periodicCleanup - Qu√©t DOCX m·ªói 30 ph√∫t');
    Logger.log('   3. reconcileCheckboxes - ƒê·ªëi so√°t checkbox m·ªói gi·ªù');
    Logger.log('   4. runScheduledCleanupAndEnsureOpen - Theo l·ªãch d·∫°y');
    Logger.log('\nüß™ Test ngay: N·ªôp th·ª≠ 1 b√†i qua Form v√† ki·ªÉm tra!');
    Logger.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    
  } catch (err) {
    Logger.log(`‚ùå L·ªói trong Quick Setup: ${err.message}`);
    Logger.log(err.stack);
  }
}

/**
 * C√†i ƒë·∫∑t triggers t·ª± ƒë·ªông
 * Ch·∫°y th·ªß c√¥ng 1 l·∫ßn sau khi:
 * - ƒê√£ add library
 * - ƒê√£ set RECIPIENT_EMAIL
 * - ƒê√£ c√≥ config trong sheet "C·∫•u H√¨nh"
 */
function setupTriggers() {
  // X√≥a triggers c≈©
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => ScriptApp.deleteTrigger(trigger));
  
  // Form submit trigger
  ScriptApp.newTrigger('onFormSubmit')
    .forForm(FormApp.getActiveForm())
    .onFormSubmit()
    .create();
  
  // Periodic DOCX cleanup (30 ph√∫t 1 l·∫ßn)
  ScriptApp.newTrigger('periodicCleanup')
    .timeBased()
    .everyMinutes(30)
    .create();
  
  // Checkbox reconciliation (1 gi·ªù 1 l·∫ßn)
  ScriptApp.newTrigger('reconcileCheckboxes')
    .timeBased()
    .everyHours(1)
    .create();
  
  Logger.log('‚úÖ ƒê√£ c√†i ƒë·∫∑t triggers c∆° b·∫£n. Ch·∫°y setupScheduledCleanup() ƒë·ªÉ th√™m cleanup theo l·ªãch.');
}

/**
 * C√†i ƒë·∫∑t cleanup triggers theo config
 * Ch·∫°y sau khi ƒë√£ c√≥ config trong sheet "C·∫•u H√¨nh"
 */
function setupScheduledCleanup() {
  try {
    // L·∫•y config tr·ª±c ti·∫øp t·ª´ Sheet (kh√¥ng qua library)
    const form = FormApp.getActiveForm();
    const destinationId = form.getDestinationId();
    
    if (!destinationId) {
      Logger.log('‚ö†Ô∏è Form ch∆∞a ƒë∆∞·ª£c link v·ªõi Sheet. Vui l√≤ng link Form v·ªõi Sheet tr∆∞·ªõc!');
      return;
    }
    
    const ss = SpreadsheetApp.openById(destinationId);
    const configSheet = ss.getSheetByName('C·∫•u H√¨nh');
    
    if (!configSheet) {
      Logger.log('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y sheet "C·∫•u H√¨nh"');
      return;
    }
    
    // ƒê·ªçc config t·ª´ sheet
    const lastRow = configSheet.getLastRow();
    if (lastRow < 2) {
      Logger.log('‚ö†Ô∏è Sheet C·∫•u H√¨nh tr·ªëng, kh√¥ng c√≥ config n√†o');
      return;
    }
    
    const dataRange = configSheet.getRange(2, 1, lastRow - 1, 6);
    const rows = dataRange.getValues();
    
    const schedules = new Set();
    
    // Parse l·ªãch h·ªçc t·ª´ m·ªói d√≤ng
    rows.forEach(row => {
      const name = String(row[0] || '').trim();
      const classTimeStr = String(row[1] || '').trim();
      
      if (!name || !classTimeStr) return;
      
      // Parse multi-schedule: "T2-18:00;T6-09:00"
      const parts = classTimeStr.split(/[;,]/).map(s => s.trim()).filter(s => s);
      
      parts.forEach(part => {
        const match = part.match(/^T(\d)-(\d{1,2}):(\d{2})$/);
        if (match) {
          const dayOfWeek = parseInt(match[1]);
          const hour = parseInt(match[2]);
          const key = `${dayOfWeek}-${hour}`;
          schedules.add(key);
        }
      });
    });
    
    if (schedules.size === 0) {
      Logger.log('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y l·ªãch h·ªçc n√†o trong config');
      return;
    }
    
    // T·∫°o trigger cho m·ªói l·ªãch duy nh·∫•t
    schedules.forEach(key => {
      const [day, hour] = key.split('-').map(Number);
      const weekday = convertDayToWeekday(day);
      
      // Cleanup 30 ph√∫t tr∆∞·ªõc gi·ªù h·ªçc
      const cleanupMinute = 30;
      
      ScriptApp.newTrigger('runScheduledCleanupAndEnsureOpen')
        .timeBased()
        .onWeekDay(weekday)
        .atHour(hour)
        .nearMinute(cleanupMinute)
        .create();
      
      Logger.log(`üìÖ Created trigger: T${day} ${hour}:${cleanupMinute}`);
    });
    
    Logger.log(`‚úÖ ƒê√£ t·∫°o ${schedules.size} cleanup triggers`);
    
  } catch (e) {
    Logger.log('‚ùå L·ªói khi setup triggers: ' + e.toString());
    Logger.log(e.stack);
  }
}

/**
 * Xem th√¥ng tin config hi·ªán t·∫°i
 */
function showCurrentConfig() {
  try {
    const form = FormApp.getActiveForm();
    const destinationId = form.getDestinationId();
    
    if (!destinationId) {
      Logger.log('‚ö†Ô∏è Form ch∆∞a ƒë∆∞·ª£c link v·ªõi Sheet');
      return;
    }
    
    const ss = SpreadsheetApp.openById(destinationId);
    const configSheet = ss.getSheetByName('C·∫•u H√¨nh');
    
    if (!configSheet) {
      Logger.log('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y sheet "C·∫•u H√¨nh"');
      return;
    }
    
    const lastRow = configSheet.getLastRow();
    if (lastRow < 2) {
      Logger.log('‚ö†Ô∏è Sheet C·∫•u H√¨nh tr·ªëng');
      return;
    }
    
    const dataRange = configSheet.getRange(2, 1, lastRow - 1, 6);
    const rows = dataRange.getValues();
    
    Logger.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    Logger.log('üìã CURRENT CONFIGURATION');
    Logger.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    
    rows.forEach((row, index) => {
      const name = String(row[0] || '').trim();
      if (!name) return;
      
      Logger.log(`\nüìå ${name}`);
      Logger.log(`   L·ªãch h·ªçc: ${row[1] || '(ch∆∞a c√≥)'}`);
      Logger.log(`   Th·ªùi gian m·ªü: ${row[2] || '(ch∆∞a c√≥)'}`);
      Logger.log(`   Deadline: ${row[3] || '(ch∆∞a c√≥)'}`);
      Logger.log(`   T·ª± ƒë·ªông d·ªçn: ${row[4] ? '‚úì' : '‚úó'}`);
      Logger.log(`   Sheet: ${row[5] || '(ch∆∞a c√≥)'}`);
    });
    
    Logger.log('\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    Logger.log(`Total: ${rows.filter(r => r[0]).length} configs`);
    
  } catch (e) {
    Logger.log('‚ùå L·ªói: ' + e.toString());
  }
}

// ==================================================================
// HELPER FUNCTIONS
// ==================================================================

function convertDayToWeekday(day) {
  const mapping = {
    1: ScriptApp.WeekDay.SUNDAY,
    2: ScriptApp.WeekDay.MONDAY,
    3: ScriptApp.WeekDay.TUESDAY,
    4: ScriptApp.WeekDay.WEDNESDAY,
    5: ScriptApp.WeekDay.THURSDAY,
    6: ScriptApp.WeekDay.FRIDAY,
    7: ScriptApp.WeekDay.SATURDAY
  };
  return mapping[day];
}
