/**
 * ============================================================================
 * FORM TEMPLATE - WRAPPER SCRIPT
 * ============================================================================
 * 
 * Script n√†y ƒë∆∞·ª£c webapp t·ª± ƒë·ªông copy khi t·∫°o l·ªõp m·ªõi.
 * Code ch√≠nh n·∫±m trong Library "FormLib" - ch·ªâ c·∫ßn c·∫≠p nh·∫≠t library l√† ƒë·ªß!
 * 
 * Setup l·∫ßn ƒë·∫ßu:
 * 1. Resources ‚Üí Libraries
 * 2. Add library ‚Üí Paste Script ID c·ªßa LibraryFormScript
 * 3. Ch·ªçn phi√™n b·∫£n m·ªõi nh·∫•t
 * 4. Identifier: "FormLib" (QUAN TR·ªåNG - ph·∫£i ƒë√∫ng t√™n n√†y!)
 * 5. [T√ôY CH·ªåN] Email th√¥ng b√°o:
 *    - T·ª± ƒë·ªông: Webapp s·∫Ω ghi email ng∆∞·ªùi t·∫°o l·ªõp v√†o Sheet Config cell I6
 *    - Th·ªß c√¥ng: File ‚Üí Project properties ‚Üí Script properties
 *      ‚Üí Add: RECIPIENT_EMAIL = email kh√°c (n·∫øu c·∫ßn override)
 *    - Ho·∫∑c: Ghi tr·ª±c ti·∫øp v√†o Sheet "C·∫•u H√¨nh" cell I6
 * 
 * Khi c·∫ßn update logic:
 * - KH√îNG S·ª¨A FILE N√ÄY
 * - S·ª≠a LibraryFormScript ‚Üí Deploy phi√™n b·∫£n m·ªõi
 * - T·∫•t c·∫£ Form t·ª± ƒë·ªông d√πng code m·ªõi!
 * 
 * ============================================================================
 */

// ==================================================================
// TRIGGER FUNCTIONS - ƒê∆ØA G·ªåI T·ª™ FORM/TRIGGERS
// ==================================================================

/**
 * X·ª≠ l√Ω khi c√≥ submission m·ªõi
 * Trigger: On form submit
 */
function onFormSubmit(e) {
  // L·∫•y email t·ª´ nhi·ªÅu ngu·ªìn (∆∞u ti√™n: Script Properties > Sheet Config)
  let recipientEmail = PropertiesService.getScriptProperties().getProperty('RECIPIENT_EMAIL');
  
  // N·∫øu kh√¥ng c√≥ trong Script Properties, ƒë·ªçc t·ª´ Sheet Config
  if (!recipientEmail) {
    try {
      recipientEmail = getEmailFromSheetConfig();
    } catch (err) {
      Logger.log('‚ö†Ô∏è Kh√¥ng th·ªÉ ƒë·ªçc email t·ª´ Sheet Config: ' + err.message);
    }
  }
  
  if (!recipientEmail) {
    Logger.log('‚ö†Ô∏è RECIPIENT_EMAIL ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t!');
    Logger.log('C√°ch 1: File ‚Üí Project properties ‚Üí Script properties ‚Üí Add: RECIPIENT_EMAIL');
    Logger.log('C√°ch 2: Ghi email v√†o Sheet "C·∫•u H√¨nh" cell I6 (Email qu·∫£n l√Ω)');
    return;
  }
  
  Logger.log(`üìß G·ª≠i th√¥ng b√°o t·ªõi: ${recipientEmail}`);
  
  // G·ªçi h√†m ch√≠nh t·ª´ library
  FormLib.onFormSubmit(e, recipientEmail);
}

/**
 * ƒê·ªçc email t·ª´ Sheet Config (cell I6)
 * Sheet ID ƒë∆∞·ª£c l·∫•y t·ª´ Form destination
 */
function getEmailFromSheetConfig() {
  try {
    const form = FormApp.getActiveForm();
    
    // L·∫•y destination spreadsheet c·ªßa Form
    const destinationId = form.getDestinationId();
    
    if (!destinationId) {
      Logger.log('‚ö†Ô∏è Form ch∆∞a ƒë∆∞·ª£c link v·ªõi Sheet n√†o');
      return null;
    }
    
    const ss = SpreadsheetApp.openById(destinationId);
    const configSheet = ss.getSheetByName('C·∫•u H√¨nh');
    
    if (!configSheet) {
      Logger.log('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y sheet "C·∫•u H√¨nh"');
      return null;
    }
    
    // ƒê·ªçc email t·ª´ cell I6 (c·ªôt 9, d√≤ng 6)
    const email = configSheet.getRange('I6').getValue();
    
    if (email && typeof email === 'string' && email.includes('@')) {
      Logger.log(`‚úÖ ƒê√£ l·∫•y email t·ª´ Sheet Config (I6): ${email}`);
      return email;
    }
    
    Logger.log('‚ö†Ô∏è Cell I6 kh√¥ng ch·ª©a email h·ª£p l·ªá');
    return null;
  } catch (e) {
    Logger.log('‚ùå L·ªói khi ƒë·ªçc email t·ª´ Sheet: ' + e.toString());
    return null;
  }
}

/**
 * Web app ƒë·ªÉ s·ª≠a email
 * Trigger: None (ƒë∆∞·ª£c g·ªçi t·ª´ link trong email)
 */
function doGet(e) {
  return FormLib.doGet(e);
}

/**
 * Cleanup v√† m·ªü form theo l·ªãch
 * Trigger: Time-based (ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông theo config)
 */
function runScheduledCleanupAndEnsureOpen() {
  FormLib.runScheduledCleanupAndEnsureOpen();
}

/**
 * Qu√©t v√† convert DOCX ƒë·ªãnh k·ª≥
 * Trigger: Time-based (30 ph√∫t 1 l·∫ßn)
 */
function periodicCleanup() {
  FormLib.periodicCleanup();
}

/**
 * ƒê·ªëi chi·∫øu checkbox gi·ªØa Drive v√† Sheet
 * Trigger: Time-based ho·∫∑c manual
 */
function reconcileCheckboxes() {
  FormLib.reconcileCheckboxes();
}

// ==================================================================
// SETUP FUNCTIONS - G·ªåI MANUAL L·∫¶N ƒê·∫¶U
// ==================================================================

/**
 * C√†i ƒë·∫∑t triggers t·ª± ƒë·ªông
 * Ch·∫°y th·ªß c√¥ng 1 l·∫ßn sau khi:
 * - ƒê√£ add library
 * - ƒê√£ set RECIPIENT_EMAIL
 * - ƒê√£ c√≥ config trong sheet "C·∫•u H√¨nh"
 */
function setupTriggers() {
  // X√≥a triggers c≈©
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => ScriptApp.deleteTrigger(trigger));
  
  // Form submit trigger
  ScriptApp.newTrigger('onFormSubmit')
    .forForm(FormApp.getActiveForm())
    .onFormSubmit()
    .create();
  
  // Periodic DOCX cleanup (30 ph√∫t 1 l·∫ßn)
  ScriptApp.newTrigger('periodicCleanup')
    .timeBased()
    .everyMinutes(30)
    .create();
  
  // Checkbox reconciliation (1 gi·ªù 1 l·∫ßn)
  ScriptApp.newTrigger('reconcileCheckboxes')
    .timeBased()
    .everyHours(1)
    .create();
  
  Logger.log('‚úÖ ƒê√£ c√†i ƒë·∫∑t triggers c∆° b·∫£n. Ch·∫°y setupScheduledCleanup() ƒë·ªÉ th√™m cleanup theo l·ªãch.');
}

/**
 * C√†i ƒë·∫∑t cleanup triggers theo config
 * Ch·∫°y sau khi ƒë√£ c√≥ config trong sheet "C·∫•u H√¨nh"
 */
function setupScheduledCleanup() {
  try {
    // L·∫•y config tr·ª±c ti·∫øp t·ª´ Sheet (kh√¥ng qua library)
    const form = FormApp.getActiveForm();
    const destinationId = form.getDestinationId();
    
    if (!destinationId) {
      Logger.log('‚ö†Ô∏è Form ch∆∞a ƒë∆∞·ª£c link v·ªõi Sheet. Vui l√≤ng link Form v·ªõi Sheet tr∆∞·ªõc!');
      return;
    }
    
    const ss = SpreadsheetApp.openById(destinationId);
    const configSheet = ss.getSheetByName('C·∫•u H√¨nh');
    
    if (!configSheet) {
      Logger.log('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y sheet "C·∫•u H√¨nh"');
      return;
    }
    
    // ƒê·ªçc config t·ª´ sheet
    const lastRow = configSheet.getLastRow();
    if (lastRow < 2) {
      Logger.log('‚ö†Ô∏è Sheet C·∫•u H√¨nh tr·ªëng, kh√¥ng c√≥ config n√†o');
      return;
    }
    
    const dataRange = configSheet.getRange(2, 1, lastRow - 1, 6);
    const rows = dataRange.getValues();
    
    const schedules = new Set();
    
    // Parse l·ªãch h·ªçc t·ª´ m·ªói d√≤ng
    rows.forEach(row => {
      const name = String(row[0] || '').trim();
      const classTimeStr = String(row[1] || '').trim();
      
      if (!name || !classTimeStr) return;
      
      // Parse multi-schedule: "T2-18:00;T6-09:00"
      const parts = classTimeStr.split(/[;,]/).map(s => s.trim()).filter(s => s);
      
      parts.forEach(part => {
        const match = part.match(/^T(\d)-(\d{1,2}):(\d{2})$/);
        if (match) {
          const dayOfWeek = parseInt(match[1]);
          const hour = parseInt(match[2]);
          const key = `${dayOfWeek}-${hour}`;
          schedules.add(key);
        }
      });
    });
    
    if (schedules.size === 0) {
      Logger.log('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y l·ªãch h·ªçc n√†o trong config');
      return;
    }
    
    // T·∫°o trigger cho m·ªói l·ªãch duy nh·∫•t
    schedules.forEach(key => {
      const [day, hour] = key.split('-').map(Number);
      const weekday = convertDayToWeekday(day);
      
      // Cleanup 30 ph√∫t tr∆∞·ªõc gi·ªù h·ªçc
      const cleanupMinute = 30;
      
      ScriptApp.newTrigger('runScheduledCleanupAndEnsureOpen')
        .timeBased()
        .onWeekDay(weekday)
        .atHour(hour)
        .nearMinute(cleanupMinute)
        .create();
      
      Logger.log(`üìÖ Created trigger: T${day} ${hour}:${cleanupMinute}`);
    });
    
    Logger.log(`‚úÖ ƒê√£ t·∫°o ${schedules.size} cleanup triggers`);
    
  } catch (e) {
    Logger.log('‚ùå L·ªói khi setup triggers: ' + e.toString());
    Logger.log(e.stack);
  }
}

/**
 * Xem th√¥ng tin config hi·ªán t·∫°i
 */
function showCurrentConfig() {
  try {
    const form = FormApp.getActiveForm();
    const destinationId = form.getDestinationId();
    
    if (!destinationId) {
      Logger.log('‚ö†Ô∏è Form ch∆∞a ƒë∆∞·ª£c link v·ªõi Sheet');
      return;
    }
    
    const ss = SpreadsheetApp.openById(destinationId);
    const configSheet = ss.getSheetByName('C·∫•u H√¨nh');
    
    if (!configSheet) {
      Logger.log('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y sheet "C·∫•u H√¨nh"');
      return;
    }
    
    const lastRow = configSheet.getLastRow();
    if (lastRow < 2) {
      Logger.log('‚ö†Ô∏è Sheet C·∫•u H√¨nh tr·ªëng');
      return;
    }
    
    const dataRange = configSheet.getRange(2, 1, lastRow - 1, 6);
    const rows = dataRange.getValues();
    
    Logger.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    Logger.log('üìã CURRENT CONFIGURATION');
    Logger.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    
    rows.forEach((row, index) => {
      const name = String(row[0] || '').trim();
      if (!name) return;
      
      Logger.log(`\nüìå ${name}`);
      Logger.log(`   L·ªãch h·ªçc: ${row[1] || '(ch∆∞a c√≥)'}`);
      Logger.log(`   Th·ªùi gian m·ªü: ${row[2] || '(ch∆∞a c√≥)'}`);
      Logger.log(`   Deadline: ${row[3] || '(ch∆∞a c√≥)'}`);
      Logger.log(`   T·ª± ƒë·ªông d·ªçn: ${row[4] ? '‚úì' : '‚úó'}`);
      Logger.log(`   Sheet: ${row[5] || '(ch∆∞a c√≥)'}`);
    });
    
    Logger.log('\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    Logger.log(`Total: ${rows.filter(r => r[0]).length} configs`);
    
  } catch (e) {
    Logger.log('‚ùå L·ªói: ' + e.toString());
  }
}

// ==================================================================
// HELPER FUNCTIONS
// ==================================================================

function convertDayToWeekday(day) {
  const mapping = {
    1: ScriptApp.WeekDay.SUNDAY,
    2: ScriptApp.WeekDay.MONDAY,
    3: ScriptApp.WeekDay.TUESDAY,
    4: ScriptApp.WeekDay.WEDNESDAY,
    5: ScriptApp.WeekDay.THURSDAY,
    6: ScriptApp.WeekDay.FRIDAY,
    7: ScriptApp.WeekDay.SATURDAY
  };
  return mapping[day];
}
