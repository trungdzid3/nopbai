/**
 * ============================================================================
 * SHEET TEMPLATE - WRAPPER SCRIPT
 * ============================================================================
 * 
 * Script nÃ y Ä‘Æ°á»£c webapp tá»± Ä‘á»™ng copy khi táº¡o lá»›p má»›i.
 * Code chÃ­nh náº±m trong Library "SheetLib" - chá»‰ cáº§n cáº­p nháº­t library lÃ  Ä‘á»§!
 * 
 * Setup láº§n Ä‘áº§u:
 * 1. Tools â†’ Script editor (trong Sheet)
 * 2. Resources â†’ Libraries
 * 3. Add library â†’ Paste Script ID cá»§a LibrarySheetScript
 * 4. Chá»n phiÃªn báº£n má»›i nháº¥t
 * 5. Identifier: "SheetLib" (QUAN TRá»ŒNG - pháº£i Ä‘Ãºng tÃªn nÃ y!)
 * 6. Save vÃ  reload sheet
 * 7. Cháº¡y menu "Tiá»‡n Ã­ch Lá»›p Há»c" â†’ "CÃ i Ä‘áº·t ToÃ n bá»™ Lá»‹ch trÃ¬nh"
 * 
 * Khi cáº§n update logic:
 * - KHÃ”NG Sá»¬A FILE NÃ€Y
 * - Sá»­a LibrarySheetScript â†’ Deploy phiÃªn báº£n má»›i
 * - Táº¥t cáº£ Sheet tá»± Ä‘á»™ng dÃ¹ng code má»›i!
 * 
 * ============================================================================
 */

// ==================================================================
// TRIGGER FUNCTIONS - Tá»° Äá»˜NG CHáº Y
// ==================================================================

/**
 * Khi má»Ÿ sheet
 * Trigger: On open
 */
function onOpen() {
  SheetLib.onOpen();
}

/**
 * Khi edit cell trong sheet
 * Trigger: On edit
 */
function onEdit(e) {
  SheetLib.onEdit(e);
}

/**
 * Cleanup tá»± Ä‘á»™ng theo lá»‹ch
 * Trigger: Time-based (Ä‘Æ°á»£c táº¡o bá»Ÿi setupSystemTriggers)
 */
function runScheduledCleanup() {
  SheetLib.runScheduledCleanup();
}

/**
 * Äiá»n "ChÆ°a ná»™p" sau deadline
 * Trigger: Time-based (Ä‘Æ°á»£c táº¡o bá»Ÿi setupSystemTriggers)
 */
function runScheduledDeadline() {
  SheetLib.runScheduledDeadline();
}

// ==================================================================
// MENU FUNCTIONS - Gá»ŒI Tá»ª MENU
// ==================================================================

/**
 * CÃ i Ä‘áº·t toÃ n bá»™ triggers tá»± Ä‘á»™ng
 * Menu: Tiá»‡n Ã­ch Lá»›p Há»c â†’ CÃ i Ä‘áº·t ToÃ n bá»™ Lá»‹ch trÃ¬nh
 */
function setupSystemTriggers() {
  SheetLib.setupSystemTriggers();
}

/**
 * Äiá»n "ChÆ°a ná»™p" thá»§ cÃ´ng
 * Menu: Tiá»‡n Ã­ch Lá»›p Há»c â†’ Cháº¡y thá»§ cÃ´ng: Äiá»n "ChÆ°a ná»™p"
 */
function manualFillNotAchieved() {
  SheetLib.manualFillNotAchieved();
}

/**
 * Hiá»ƒn thá»‹ dialog cleanup tÃ¹y chá»n
 * Menu: Tiá»‡n Ã­ch Lá»›p Há»c â†’ Cháº¡y thá»§ cÃ´ng: Dá»n dáº¹p (TÃ¹y chá»n)
 */
function showCleanupDialog() {
  SheetLib.showCleanupDialog();
}

/**
 * Xem cáº¥u hÃ¬nh hiá»‡n táº¡i
 * Menu: Tiá»‡n Ã­ch Lá»›p Há»c â†’ Xem cáº¥u hÃ¬nh hiá»‡n táº¡i
 */
function showCurrentConfig() {
  SheetLib.showCurrentConfig();
}

/**
 * Hiá»ƒn thá»‹ hÆ°á»›ng dáº«n setup
 * Menu: Tiá»‡n Ã­ch Lá»›p Há»c â†’ HÆ°á»›ng dáº«n Setup láº§n Ä‘áº§u
 */
function showFirstTimeSetupGuide() {
  SheetLib.showFirstTimeSetupGuide();
}

/**
 * Äá»‘i soÃ¡t checkboxes - So sÃ¡nh Drive vÃ  Sheet
 * Menu: Tiá»‡n Ã­ch Lá»›p Há»c â†’ Äá»‘i soÃ¡t Checkbox
 * 
 * Chá»©c nÄƒng:
 * - QuÃ©t táº¥t cáº£ folders bÃ i táº­p trÃªn Drive
 * - So sÃ¡nh vá»›i danh sÃ¡ch há»c sinh trong Sheet
 * - Tá»± Ä‘á»™ng tick checkbox cho há»c sinh Ä‘Ã£ ná»™p nhÆ°ng chÆ°a Ä‘Ã¡nh dáº¥u
 */
function reconcileCheckboxes() {
  try {
    // Láº¥y Class Folder ID tá»« cell I3
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const configSheet = ss.getSheetByName('Cáº¥u HÃ¬nh');
    
    if (!configSheet) {
      Browser.msgBox('Lá»—i', 'KhÃ´ng tÃ¬m tháº¥y sheet "Cáº¥u HÃ¬nh"', Browser.Buttons.OK);
      return;
    }
    
    const classFolderId = configSheet.getRange('I3').getValue();
    
    if (!classFolderId) {
      Browser.msgBox(
        'Thiáº¿u thÃ´ng tin',
        'ChÆ°a cÃ³ Class Folder ID trong cell I3.\n\nHÃ£y cháº¡y "Äá»“ng bá»™ & LiÃªn káº¿t" trÃªn web app trÆ°á»›c.',
        Browser.Buttons.OK
      );
      return;
    }
    
    // Gá»i FormLib Ä‘á»ƒ thá»±c hiá»‡n Ä‘á»‘i soÃ¡t
    Browser.msgBox(
      'Báº¯t Ä‘áº§u Ä‘á»‘i soÃ¡t',
      'Äang quÃ©t Drive vÃ  cáº­p nháº­t checkbox...\n\nQuÃ¡ trÃ¬nh nÃ y cÃ³ thá»ƒ máº¥t vÃ i phÃºt.',
      Browser.Buttons.OK
    );
    
    // Gá»i FormLib.reconcileCheckboxes (Library cá»§a Form)
    if (typeof FormLib !== 'undefined' && FormLib.reconcileCheckboxes) {
      FormLib.reconcileCheckboxes(classFolderId);
      
      Browser.msgBox(
        'HoÃ n táº¥t',
        'ÄÃ£ Ä‘á»‘i soÃ¡t xong!\n\nKiá»ƒm tra Logs (Ctrl+Enter) Ä‘á»ƒ xem chi tiáº¿t.',
        Browser.Buttons.OK
      );
    } else {
      Browser.msgBox(
        'Lá»—i',
        'KhÃ´ng tÃ¬m tháº¥y FormLib.\n\nHÃ£y Ä‘áº£m báº£o Ä‘Ã£ add Library "FormLib" vÃ o project nÃ y.',
        Browser.Buttons.OK
      );
    }
    
  } catch (e) {
    Logger.log('âŒ Lá»—i reconcileCheckboxes: ' + e.message);
    Browser.msgBox('Lá»—i', 'Lá»—i khi Ä‘á»‘i soÃ¡t: ' + e.message, Browser.Buttons.OK);
  }
}

/**
 * Thá»±c hiá»‡n cleanup vá»›i options (Ä‘Æ°á»£c gá»i tá»« dialog)
 * Internal: Gá»i tá»« HTML dialog
 */
function executeCleanupWithOptions(options) {
  SheetLib.executeCleanupWithOptions(options);
}

// ==================================================================
// TESTING & DEBUG
// ==================================================================

/**
 * Test cáº¥u hÃ¬nh cÃ³ Ä‘á»c Ä‘Æ°á»£c khÃ´ng
 */
function testConfigLoading() {
  try {
    // Táº¡o ConfigManager tá»« library
    const ConfigManager = SheetLib.ConfigManager || function() {
      throw new Error('ConfigManager khÃ´ng tÃ¬m tháº¥y trong SheetLib. Kiá»ƒm tra library Ä‘Ã£ add chÆ°a?');
    };
    
    const configMgr = new ConfigManager();
    configMgr.loadAll();
    
    const configs = configMgr.getAll();
    
    Logger.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    Logger.log('âœ… TEST CONFIG LOADING');
    Logger.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    Logger.log(`Found ${configs.length} configs:`);
    
    configs.forEach((config, index) => {
      Logger.log(`\n${index + 1}. ${config.name}`);
      Logger.log(`   Sheet: ${config.sheetName || '(none)'}`);
      Logger.log(`   Class schedules: ${config.classSchedules.length}`);
      Logger.log(`   Auto clean: ${config.autoClean}`);
    });
    
    Logger.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    Logger.log('âœ… Config loading successful!');
    
  } catch (e) {
    Logger.log('âŒ ERROR: ' + e.message);
    Logger.log(e.stack);
  }
}

/**
 * Liá»‡t kÃª táº¥t cáº£ triggers hiá»‡n táº¡i
 */
function listCurrentTriggers() {
  const triggers = ScriptApp.getProjectTriggers();
  
  Logger.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  Logger.log('ğŸ“‹ CURRENT TRIGGERS');
  Logger.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  Logger.log(`Total: ${triggers.length} triggers\n`);
  
  if (triggers.length === 0) {
    Logger.log('âš ï¸ No triggers found!');
    Logger.log('Run setupSystemTriggers() from menu to create them.');
  } else {
    triggers.forEach((trigger, index) => {
      Logger.log(`${index + 1}. ${trigger.getHandlerFunction()}`);
      Logger.log(`   Type: ${trigger.getEventType()}`);
      
      const triggerSource = trigger.getTriggerSource();
      if (triggerSource) {
        Logger.log(`   Source: ${triggerSource}`);
      }
      
      Logger.log('');
    });
  }
  
  Logger.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
}

/**
 * XÃ³a táº¥t cáº£ triggers (dÃ¹ng khi muá»‘n reset)
 */
function deleteAllTriggers() {
  const triggers = ScriptApp.getProjectTriggers();
  const count = triggers.length;
  
  triggers.forEach(trigger => ScriptApp.deleteTrigger(trigger));
  
  Logger.log(`ğŸ—‘ï¸ Deleted ${count} triggers`);
  Logger.log('Run setupSystemTriggers() from menu to recreate them.');
}
